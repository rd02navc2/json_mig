<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAA 資料管理系統</title>
    <link th:href="@{/lib/bootstrap.min.css}" rel="stylesheet">
    <style nonce="bkZ0dkFwMjAyNA==">
        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin-top: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: 600;
        }
        td[contenteditable="true"] {
            background-color: #fff7e6;
            cursor: text;
        }
        td[contenteditable="true"]:focus {
            outline: 2px solid #ffa500;
            background-color: #fffacd;
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .search-box {
            max-width: 400px;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }

        /* ===== 側邊欄 ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: #fafafa !important;
            color: #1a1a1a !important;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid #e0e0e0 !important;
            box-shadow: 2px 0 8px rgba(0,0,0,0.04);
        }

        /* 標題區 */
        .sidebar-header {
            padding: 20px 18px;
            background: #ffffff !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .sidebar-header h4 {
            font-size: 14px;
            font-weight: 500;
            margin: 0;
            line-height: 1.4;
            color: #1a1a1a !important;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* 選單 */
        .sidebar-menu {
            list-style: none;
            padding: 4px 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 0;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 18px;
            color: #4a4a4a !important;
            text-decoration: none;
            border-left: 2px solid transparent;
            transition: all 0.15s ease;
            font-size: 15px;
            font-weight: 400;
        }

        /* hover */
        .sidebar-menu a:hover {
            background: #f0f0f0 !important;
            color: #1a1a1a !important;
            border-left-color: #bdbdbd !important;
        }

        /* 選取狀態 */
        .sidebar-menu a.active,
        .sidebar-menu a[aria-current="page"],
        .sidebar-menu .active > a {
            background: #ffffff !important;
            color: #1a1a1a !important;
            border-left-color: #1a1a1a !important;
            font-weight: 500;
        }

    </style>
</head>
<body>
<div class="layout">
    <!-- 側邊欄 -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="container">
        <h1 class="text-center mb-4">
            <i class="bi bi-database"></i> AAA 資料管理系統
        </h1>

        <div id="alertContainer"></div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-plus-circle"></i> 新增資料
            </div>
            <div class="card-body">
                <form id="addForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="cls" class="form-label">Cls (主鍵) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cls" required>
                            <div id="clsMsg" class="form-text"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="chn" class="form-label">中文名稱</label>
                            <input type="text" class="form-control" id="chn">
                        </div>
                        <div class="col-md-4">
                            <label for="car" class="form-label">Car</label>
                            <input type="number" class="form-control" id="car">
                        </div>
                        <div class="col-md-4">
                            <label for="boro" class="form-label">Boro</label>
                            <input type="number" class="form-control" id="boro">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100" id="submitBtn">
                                <i class="bi bi-check-circle"></i> 新增
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-search"></i> 搜尋功能
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchName" placeholder="搜尋 Name...">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchChn" placeholder="搜尋中文名稱...">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-info w-100" type="button" onclick="searchData()">
                            <i class="bi bi-search"></i> 搜尋
                        </button>
                        <button class="btn btn-secondary w-100 mt-2" type="button" onclick="loadData()">
                            <i class="bi bi-arrow-clockwise"></i> 重新載入
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> 資料列表</span>
                <span id="dataCount" class="badge bg-light text-dark">載入中...</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="dataTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 150px;">Cls</th>
                                <th style="width: 200px;">Name</th>
                                <th style="width: 200px;">中文名稱</th>
                                <th style="width: 100px;">Car</th>
                                <th style="width: 100px;">Boro</th>
                                <th style="width: 150px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="6" class="loading">載入資料中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 保留 bootstrap.bundle (含 modal, alert 關閉按鈕行為) -->
    <script th:src="@{/lib/bootstrap/bootstrap.bundle.min.js}"></script>

    <script th:inline="javascript" nonce="bkZ0dkFwMjAyNA==">
        const API_BASE = '/api/aaa';

        document.addEventListener('DOMContentLoaded', function () {
            loadData();
            setupEventListeners();
        });

        function $(selector) {
            return document.querySelector(selector);
        }
        function $all(selector) {
            return Array.from(document.querySelectorAll(selector));
        }

        function setupEventListeners() {
            const clsInput = $("#cls");
            const clsMsg = $("#clsMsg");
            const submitBtn = $("#submitBtn");
            const addForm = $("#addForm");
            const searchName = $("#searchName");
            const searchChn = $("#searchChn");

            clsInput.addEventListener('input', function () {
                const cls = clsInput.value.trim();

                clsMsg.textContent = '';
                clsMsg.classList.remove('text-success', 'text-danger', 'text-warning');
                submitBtn.disabled = false;

                if (!cls) {
                    return;
                }

                fetch(API_BASE + '/check/' + encodeURIComponent(cls))
                    .then(function (res) {
                        if (!res.ok) throw new Error();
                        return res.json();
                    })
                    .then(function (data) {
                        if (data.exists) {
                            clsMsg.textContent = '❌ Cls 已存在';
                            clsMsg.classList.remove('text-success');
                            clsMsg.classList.add('text-danger');
                            submitBtn.disabled = true;
                        } else {
                            clsMsg.textContent = '✅ 可使用';
                            clsMsg.classList.remove('text-danger');
                            clsMsg.classList.add('text-success');
                            submitBtn.disabled = false;
                        }
                    })
                    .catch(function () {
                        clsMsg.textContent = '檢查失敗';
                        clsMsg.classList.remove('text-success', 'text-danger');
                        clsMsg.classList.add('text-warning');
                    });
            });

            addForm.addEventListener('submit', function (e) {
                e.preventDefault();
                addData();
            });

            function handleSearchKeypress(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchData();
                }
            }
            searchName.addEventListener('keypress', handleSearchKeypress);
            searchChn.addEventListener('keypress', handleSearchKeypress);
        }

        function showAlert(message, type) {
            type = type || 'success';
            const alertContainer = $("#alertContainer");

            const wrapper = document.createElement('div');
            wrapper.className = 'alert alert-' + type + ' alert-dismissible fade show';
            wrapper.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(wrapper);

            setTimeout(function () {
                if (wrapper && wrapper.parentNode) {
                    wrapper.parentNode.removeChild(wrapper);
                }
            }, 3000);
        }

        function loadData() {
            const tbody = $("#tableBody");
            tbody.innerHTML = '<tr><td colspan="6" class="loading">載入資料中...</td></tr>';

            fetch(API_BASE)
                .then(function (res) {
                    if (!res.ok) {
                        return res.json().catch(function () {
                            throw new Error('載入失敗');
                        }).then(function (json) {
                            throw new Error(json.message || '載入失敗');
                        });
                    }
                    return res.json();
                })
                .then(function (data) {
                    if (data.status === 'success') {
                        displayData(data.data);
                    } else {
                        throw new Error(data.message || '載入失敗');
                    }
                })
                .catch(function (err) {
                    const errorMsg = err.message || '載入失敗';
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">載入失敗: ' + errorMsg + '</td></tr>';
                    showAlert('載入資料失敗: ' + errorMsg, 'danger');
                });
        }

        function displayData(dataList) {
            const tbody = $("#tableBody");
            const dataCount = $("#dataCount");

            dataCount.textContent = '共 ' + dataList.length + ' 筆資料';

            if (!dataList || dataList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">無資料</td></tr>';
                return;
            }

            let html = '';
            dataList.forEach(function (item) {
                html += '<tr id="row-' + item.cls + '">';
                html += '<td>' + item.cls + '</td>';
                html += '<td contenteditable="true" class="editable" data-field="name" data-cls="' + item.cls + '">' + (item.name || '') + '</td>';
                html += '<td contenteditable="true" class="editable" data-field="chn" data-cls="' + item.cls + '">' + (item.chn || '') + '</td>';
                html += '<td contenteditable="true" class="editable" data-field="car" data-cls="' + item.cls + '">' + (item.car !== null ? item.car : '') + '</td>';
                html += '<td contenteditable="true" class="editable" data-field="boro" data-cls="' + item.cls + '">' + (item.boro !== null ? item.boro : '') + '</td>';
                html += '<td><button class="btn btn-sm btn-danger" type="button" onclick="deleteData(\'' + item.cls + '\')"><i class="bi bi-trash"></i> 刪除</button></td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;

            $all('.editable').forEach(function (cell) {
                cell.addEventListener('blur', function () {
                    updateField(cell);
                });
            });
        }

        function addData() {
            const cls = $("#cls").value.trim();
            const name = $("#name").value.trim();
            const chn = $("#chn").value.trim();
            const carVal = $("#car").value;
            const boroVal = $("#boro").value;

            const data = {
                cls: cls,
                name: name,
                chn: chn ? chn : null,
                car: carVal ? parseInt(carVal, 10) : null,
                boro: boroVal ? parseInt(boroVal, 10) : null
            };

            if (!data.cls || !data.name) {
                showAlert('請填寫必填欄位', 'warning');
                return;
            }

            fetch(API_BASE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(function (res) {
                    return res.json().catch(function () {
                        throw new Error('新增失敗');
                    }).then(function (json) {
                        if (!res.ok) {
                            throw new Error(json.message || '新增失敗');
                        }
                        return json;
                    });
                })
                .then(function (result) {
                    if (result.status === 'success') {
                        showAlert(result.message, 'success');
                        $("#addForm").reset();
                        $("#clsMsg").textContent = '';
                        loadData();
                    } else {
                        showAlert(result.message, 'danger');
                    }
                })
                .catch(function (err) {
                    const errorMsg = err.message || '新增失敗';
                    showAlert('新增失敗: ' + errorMsg, 'danger');
                });
        }

        function updateField(element) {
            const cls = element.getAttribute('data-cls');
            const field = element.getAttribute('data-field');
            let value = element.textContent.trim();

            if (field === 'car' || field === 'boro') {
                value = value ? parseInt(value, 10) : null;
            }

            const updates = {};
            updates[field] = value;

            fetch(API_BASE + '/' + encodeURIComponent(cls), {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updates)
            })
                .then(function (res) {
                    return res.json().catch(function () {
                        throw new Error('更新失敗');
                    }).then(function (json) {
                        if (!res.ok) {
                            throw new Error(json.message || '更新失敗');
                        }
                        return json;
                    });
                })
                .then(function (result) {
                    if (result.status === 'success') {
                        element.style.backgroundColor = '#d4edda';
                        setTimeout(function () {
                            element.style.backgroundColor = '#fff7e6';
                        }, 500);
                    } else {
                        element.style.backgroundColor = '#f8d7da';
                        showAlert('更新失敗: ' + result.message, 'danger');
                    }
                })
                .catch(function (err) {
                    element.style.backgroundColor = '#f8d7da';
                    const errorMsg = err.message || '更新失敗';
                    showAlert('更新失敗: ' + errorMsg, 'danger');
                });
        }

        function deleteData(cls) {
            if (!confirm('確定要刪除 ' + cls + ' 嗎？')) return;

            fetch(API_BASE + '/' + encodeURIComponent(cls), {
                method: 'DELETE'
            })
                .then(function (res) {
                    return res.json().catch(function () {
                        throw new Error('刪除失敗');
                    }).then(function (json) {
                        if (!res.ok) {
                            throw new Error(json.message || '刪除失敗');
                        }
                        return json;
                    });
                })
                .then(function (result) {
                    if (result.status === 'success') {
                        showAlert(result.message, 'success');
                        const row = document.getElementById('row-' + cls);
                        if (row && row.parentNode) {
                            row.parentNode.removeChild(row);
                        }
                        const count = $("#tableBody").querySelectorAll('tr').length;
                        $("#dataCount").textContent = '共 ' + count + ' 筆資料';
                    } else {
                        showAlert('刪除失敗: ' + result.message, 'danger');
                    }
                })
                .catch(function (err) {
                    const errorMsg = err.message || '刪除失敗';
                    showAlert('刪除失敗: ' + errorMsg, 'danger');
                });
        }

        function searchData() {
            const name = $("#searchName").value.trim();
            const chn = $("#searchChn").value.trim();

            let url = API_BASE + '/search?';
            const params = [];
            if (name) params.push('name=' + encodeURIComponent(name));
            if (chn) params.push('chn=' + encodeURIComponent(chn));
            url += params.join('&');

            fetch(url)
                .then(function (res) {
                    return res.json().catch(function () {
                        throw new Error('搜尋失敗');
                    }).then(function (json) {
                        if (!res.ok) {
                            throw new Error(json.message || '搜尋失敗');
                        }
                        return json;
                    });
                })
                .then(function (data) {
                    if (data.status === 'success') {
                        displayData(data.data);
                        showAlert('找到 ' + data.data.length + ' 筆資料', 'info');
                    } else {
                        showAlert('搜尋失敗: ' + data.message, 'danger');
                    }
                })
                .catch(function (err) {
                    const errorMsg = err.message || '搜尋失敗';
                    showAlert('搜尋失敗: ' + errorMsg, 'danger');
                });
        }
    </script>
</div>
</body>
</html>
