<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MIG資料調和系統</title>
    <link th:href="@{/lib/bootstrap.min.css}" rel="stylesheet">
    <script th:src="@{/lib/jquery/jquery-3.6.0.min.js}"></script>
    <style>
        body, input, textarea, select, button {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            font-size: 16px;
        }
        .layout { display:flex; min-height:100vh; background-color:#f8f9fa; }
        .sidebar { position:fixed; left:0; top:0; width:240px; height:100vh; background:#fff; color:#000; overflow-y:auto; border-right:1px solid #dcdcdc; }
        .sidebar-header { padding:16px 15px; background:#f5f5f5; border-bottom:1px solid #dcdcdc; }
        .sidebar-header h4 { font-size:15px; font-weight:600; margin:0; }
        .sidebar-menu { list-style:none; padding:8px 0; margin:0; }
        .sidebar-menu li { margin:0; }
        .sidebar-menu a { display:block; padding:10px 18px; color:#000; text-decoration:none; border-left:3px solid transparent; }
        .sidebar-menu a:hover { background:#f2f2f2; }
        .sidebar-menu a.active { background:#e9ecef; font-weight:600; border-left-color:#0d6efd; }
        .main-content { flex:1; padding:20px 24px; margin-left:240px; }
        td[contenteditable="true"] { background-color:#fff7e6; cursor:text; }
        td[contenteditable="true"]:focus { outline:2px solid #ffa500; }
        .form-text.text-danger { color:#dc3545 !important; }
    </style>
</head>
<body>
<div class="layout">
    <!-- 側邊欄 -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- 主內容 -->
    <div class="main-content">
        <div class="container-fluid my-2">
            <h2 class="mb-4">資料調和系統 - Twcls 管理</h2>

            <div id="formMessage"></div>

            <!-- 新增表單 -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">新增 Class / Field</div>
                <div class="card-body">
                    <form id="addTwclsForm">
                        <div class="mb-3">
                            <label for="classId" class="form-label">ClassId</label>
                            <input type="text" class="form-control" name="classId" id="classId" required>
                            <div id="classIdMsg" class="form-text"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Class Name</label>
                            <input type="text" class="form-control" name="className" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">CH Name</label>
                            <input type="text" class="form-control" name="chName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">EN Name</label>
                            <input type="text" class="form-control" name="enName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">CH Def</label>
                            <input type="text" class="form-control" name="chDef">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">EN Def</label>
                            <input type="text" class="form-control" name="enDef">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Object Class</label>
                            <input type="text" class="form-control" name="objectClass" id="objectClass" required>
                            <div id="objectClassMsg" class="form-text text-danger"></div>
                        </div>
                        <button type="submit" class="btn btn-success" id="submitBtn">新增</button>
                    </form>
                </div>
            </div>

            <!-- 列表 -->
            <div class="card">
                <div class="card-header bg-secondary text-white">目前資料</div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0" id="twclsTable">
                        <thead class="table-light">
                        <tr>
                            <th>ClassId</th>
                            <th>ClassName</th>
                            <th>CH Name</th>
                            <th>EN Name</th>
                            <th>CH Def</th>
                            <th>EN Def</th>
                            <th>ObjectClass</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cls : ${classes}" th:id="'row-' + ${cls.classId}">
                            <td th:text="${cls.classId}"></td>
                            <td contenteditable="true" class="editable" data-field="className" th:text="${cls.className}"></td>
                            <td contenteditable="true" class="editable" data-field="chName" th:text="${cls.chName}"></td>
                            <td contenteditable="true" class="editable" data-field="enName" th:text="${cls.enName}"></td>
                            <td contenteditable="true" class="editable" data-field="chDef" th:text="${cls.chDef}"></td>
                            <td contenteditable="true" class="editable" data-field="enDef" th:text="${cls.enDef}"></td>
                            <td contenteditable="true" class="editable" data-field="objectClass" th:text="${cls.objectClass}"></td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-btn" th:data-obj="${cls.objectClass}">刪除</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script th:src="@{/lib/bootstrap/bootstrap.bundle.min.js}"></script>
<script>
$(function(){

    // ClassId 即時檢查
    $("#classId").on("input", function(){
        let classId = $(this).val().trim();
        if(!classId){
            $("#classIdMsg").text("").removeClass("text-success text-danger");
            $("#submitBtn").prop("disabled", false);
            return;
        }
        $.get("/twcls/ajax/check/"+classId,function(res){
            if(res.exists){
                $("#classIdMsg").text("ClassId 已存在").removeClass("text-success").addClass("text-danger");
                $("#submitBtn").prop("disabled", true);
            }else{
                $("#classIdMsg").text("可使用").removeClass("text-danger").addClass("text-success");
                $("#submitBtn").prop("disabled", false);
            }
        }).fail(function(){
            $("#classIdMsg").text("檢查失敗").removeClass("text-success").addClass("text-danger");
            $("#submitBtn").prop("disabled", false);
        });
    });

    // AJAX 新增
    $("#addTwclsForm").submit(function(e){
        e.preventDefault();

        let objectClass = $("#objectClass").val().trim();
        if(!objectClass){
            $("#objectClassMsg").text("請輸入 ObjectClass");
            return;
        } else {
            $("#objectClassMsg").text("");
        }

        let formData = {
            classId: $("#classId").val().trim(),
            className: $("input[name='className']").val().trim(),
            chName: $("input[name='chName']").val().trim(),
            enName: $("input[name='enName']").val().trim(),
            chDef: $("input[name='chDef']").val().trim(),
            enDef: $("input[name='enDef']").val().trim(),
            objectClass: objectClass
        };

        $.ajax({
            url:"/twcls/ajax/add",
            type:"POST",
            contentType:"application/json",
            data:JSON.stringify(formData),
            success:function(res){
                if(res.status==="success"){
                    let cls = res.data;
                    let newRow = `
                        <tr id="row-${cls.classId}">
                            <td>${cls.classId}</td>
                            <td contenteditable="true" class="editable" data-field="className">${cls.className}</td>
                            <td contenteditable="true" class="editable" data-field="chName">${cls.chName}</td>
                            <td contenteditable="true" class="editable" data-field="enName">${cls.enName}</td>
                            <td contenteditable="true" class="editable" data-field="chDef">${cls.chDef}</td>
                            <td contenteditable="true" class="editable" data-field="enDef">${cls.enDef}</td>
                            <td contenteditable="true" class="editable" data-field="objectClass">${cls.objectClass}</td>
                            <td><button class="btn btn-sm btn-danger delete-btn" data-obj="${cls.objectClass}">刪除</button></td>
                        </tr>
                    `;
                    $("#twclsTable tbody").append(newRow);
                    $("#formMessage").html(`<div class="alert alert-success">${res.message}</div>`);
                    $("#addTwclsForm")[0].reset();
                    $("#classIdMsg").text("");
                    $("#objectClassMsg").text("");
                    $("#submitBtn").prop("disabled", false);
                    $('html,body').animate({scrollTop: $("#row-"+cls.classId).offset().top-100},500);
                }else{
                    $("#formMessage").html(`<div class="alert alert-danger">${res.message}</div>`);
                }
            },
            error:function(){
                $("#formMessage").html(`<div class="alert alert-danger">新增 AJAX 發生錯誤</div>`);
            }
        });
    });

    // AJAX 刪除
    $("#twclsTable").on("click",".delete-btn",function(){
        if(!confirm("確定要刪除嗎？")) return;
        let objectClass = $(this).data("obj");
        let row = $(this).closest("tr");
        $.ajax({
            url:"/twcls/ajax/"+objectClass,
            type:"DELETE",
            success:function(res){
                if(res.status==="success"){
                    row.remove();
                    alert(res.message);
                }else{
                    alert("刪除失敗："+res.message);
                }
            },
            error:function(){
                alert("刪除 AJAX 發生錯誤！");
            }
        });
    });

    // AJAX 編輯
    $("#twclsTable").on("blur",".editable",function(){
        let td = $(this);
        let field = td.data("field");
        let newValue = td.text().trim();
        let classId = td.closest("tr").attr("id").replace("row-","");
        let data = {};
        data[field] = newValue;

        $.ajax({
            url:"/twcls/ajax/update/"+classId,
            type:"PATCH",
            contentType:"application/json",
            data:JSON.stringify(data),
            success:function(res){
                if(res.status==="success"){
                    td.css("background-color","#d4ffd4");
                    setTimeout(()=>td.css("background-color","#fff7e6"),500);
                }else{
                    td.css("background-color","#ffd4d4");
                    alert("更新失敗："+res.message);
                }
            },
            error:function(){
                td.css("background-color","#ffd4d4");
                alert("更新 AJAX 發生錯誤！");
            }
        });
    });

});
</script>
</body>
</html>
