<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å±¬æ€§æ¬„ä½ç¶­è­·ç·¨è¼¯ç³»çµ± (JavaParser ç‰ˆ)</title>
<style>
body {
    font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

h1 {
    color: #003c75;
    border-bottom: 3px solid #003c75;
    padding-bottom: 10px;
    margin-top: 0;
}

#alertContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
}

.file-load-section {
    background: #e8f5e9;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 25px;
    border: 2px solid #4caf50;
}

.file-load-section h3 {
    margin-top: 0;
    color: #2e7d32;
}

.search-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 25px;
    border: 1px solid #ddd;
}

.search-section h3 {
    margin-top: 0;
    color: #003c75;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-group input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 15px;
    box-sizing: border-box;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.checkbox-label {
    font-weight: normal;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
}

.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #003c75;
    color: white;
}

.btn-primary:hover {
    background: #002a63;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-danger {
    background: #dc3545;
    color: white;
    padding: 6px 12px;
    font-size: 14px;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-add {
    background: #17a2b8;
    color: white;
    margin-top: 10px;
}

.btn-add:hover {
    background: #138496;
}

.btn-load {
    background: #4caf50;
    color: white;
}

.btn-load:hover {
    background: #45a049;
}

.btn-info {
    background: #17a2b8;
    color: white;
    padding: 8px 20px;
    font-size: 14px;
}

.btn-info:hover {
    background: #138496;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-warning:hover {
    background: #e68900;
}

.result-section {
    display: none;
    margin-top: 30px;
}

.search-results {
    background: #fff3cd;
    padding: 20px;
    border-radius: 6px;
    border: 1px solid #ffc107;
    margin-bottom: 25px;
}

.search-results h4 {
    margin-top: 0;
    color: #856404;
}

.result-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.result-item:hover {
    background: #f0f0f0;
    border-color: #003c75;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.result-item.selected {
    background: #e3f2fd;
    border: 2px solid #2196f3;
}

.result-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.result-item-title {
    font-weight: bold;
    font-size: 16px;
    color: #003c75;
}

.result-item-path {
    font-size: 13px;
    color: #666;
    margin-bottom: 10px;
}

.result-item-code {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    white-space: pre-wrap;
    border: 1px solid #dee2e6;
}

.db-enrichment {
    background: #e8f5e9;
    padding: 10px;
    margin-top: 10px;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid #4caf50;
}

.db-enrichment strong {
    color: #2e7d32;
}

.code-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    margin-bottom: 25px;
}

.code-preview h4 {
    margin-top: 0;
    color: #003c75;
}

.code-preview pre {
    background: #ffffff;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #ddd;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
}

.edit-section {
    background: #ffffff;
    padding: 20px;
    border-radius: 6px;
    border: 2px solid #003c75;
}

.edit-section h4 {
    margin-top: 0;
    color: #003c75;
    border-bottom: 2px solid #003c75;
    padding-bottom: 8px;
}

.field-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.field-table th {
    background: #003c75;
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: bold;
}

.field-table td {
    padding: 10px;
    border: 1px solid #ddd;
}

.field-table tr:nth-child(even) {
    background: #f9f9f9;
}

.field-table input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    box-sizing: border-box;
}

.field-row {
    background: white;
}

.field-row:hover {
    background: #f0f0f0;
}

.section-header {
    background: #e9ecef;
    font-weight: bold;
    color: #003c75;
}

.action-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}

.alert .close-btn {
    float: right;
    font-size: 20px;
    font-weight: bold;
    line-height: 1;
    cursor: pointer;
    opacity: 0.5;
}

.alert .close-btn:hover {
    opacity: 1;
}

.file-info {
    background: white;
    padding: 15px;
    border-radius: 4px;
    margin-top: 10px;
    border: 1px solid #4caf50;
}

.file-info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e0e0e0;
}

.file-info-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.file-info-label {
    font-weight: bold;
    color: #2e7d32;
}

.file-info-value {
    color: #333;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}

.badge-count {
    background: #ffc107;
    color: #000;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-info {
    background: #17a2b8;
    color: white;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,.1);
    border-radius: 50%;
    border-top-color: #003c75;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.db-info-panel {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid #b3d9ff;
}

.db-info-panel h5 {
    margin-top: 0;
    color: #003c75;
    font-size: 14px;
}

.db-info-item {
    margin-bottom: 8px;
    font-size: 13px;
}

.db-info-item strong {
    color: #003c75;
}

.batch-actions {
    background: #fff9e6;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 25px;
    border: 1px solid #ffd966;
}

.batch-actions h3 {
    margin-top: 0;
    color: #856404;
    font-size: 16px;
}

.progress-container {
    display: none;
    background: white;
    padding: 20px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid #ddd;
}

.progress-bar-wrapper {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    margin: 15px 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 14px;
}

.progress-status {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.status-badge.total {
    background: #e3f2fd;
    color: #1976d2;
}

.status-badge.success {
    background: #d4edda;
    color: #155724;
}

.status-badge.failed {
    background: #f8d7da;
    color: #721c24;
}

.progress-details {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 13px;
    font-family: 'Courier New', monospace;
}

.progress-details div {
    padding: 3px 0;
    border-bottom: 1px solid #e0e0e0;
}

.progress-details div:last-child {
    border-bottom: none;
}

.progress-details .success-item {
    color: #28a745;
}

.progress-details .error-item {
    color: #dc3545;
}

.progress-details .processing-item {
    color: #856404;
}
</style>
</head>
<body>
<div id="alertContainer"></div>

<div class="container">
    <h1>å±¬æ€§æ¬„ä½ç¶­è­·ç·¨è¼¯ç³»çµ± <span class="badge badge-info">JavaParser ç‰ˆ</span></h1>
    
    <!-- æª”æ¡ˆè¼‰å…¥å€å¡Š -->
    <div class="file-load-section">
        <h3>ğŸ“„ è¼‰å…¥ Java æª”æ¡ˆ</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            ç³»çµ±å°‡è¼‰å…¥é è¨­çš„ <strong>MyMapping.java</strong> æª”æ¡ˆé€²è¡Œç·¨è¼¯
        </p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-load" id="loadBtn" onclick="loadDefaultFile()">è¼‰å…¥æª”æ¡ˆ</button>
            <button class="btn btn-warning" id="reloadBtn" onclick="reloadFile()" style="display:none;">é‡æ–°è¼‰å…¥ï¼ˆæ”¾æ£„è®Šæ›´ï¼‰</button>
        </div>
        <div id="fileInfo" class="file-info" style="display:none;">
            <div class="file-info-row">
                <span class="file-info-label">æª”æ¡ˆåç¨±:</span>
                <span class="file-info-value" id="fileName"></span>
            </div>
            <div class="file-info-row">
                <span class="file-info-label">æª”æ¡ˆè·¯å¾‘:</span>
                <span class="file-info-value" id="filePath"></span>
            </div>
            <div class="file-info-row">
                <span class="file-info-label">æª”æ¡ˆå¤§å°:</span>
                <span class="file-info-value" id="fileSize"></span>
            </div>
            <div class="file-info-row">
                <span class="file-info-label">ç¸½è¡Œæ•¸:</span>
                <span class="file-info-value" id="fileLines"></span>
            </div>
            <div class="file-info-row">
                <span class="file-info-label">æ¬„ä½æ•¸é‡:</span>
                <span class="file-info-value" id="fieldCount"></span>
            </div>
        </div>
    </div>

    <!-- æ‰¹æ¬¡æ“ä½œå€å¡Š -->
    <div class="batch-actions">
        <h3>æ‰¹æ¬¡æ“ä½œ</h3>
        <button class="btn btn-secondary" onclick="batchImportToDb()">æ‰¹æ¬¡åŒ¯å…¥æ‰€æœ‰æ¬„ä½åˆ°è³‡æ–™åº«</button>
        <p style="font-size: 13px; color: #666; margin-top: 10px;">
            âš ï¸ æ­¤æ“ä½œæœƒå°‡æª”æ¡ˆä¸­æ‰€æœ‰å¸¶æœ‰ @DSREF è¨»è§£çš„æ¬„ä½åŒæ­¥åˆ°è³‡æ–™åº«
        </p>
        
        <div id="progressContainer" class="progress-container">
            <h4 style="margin-top: 0; color: #003c75;">åŒ¯å…¥é€²åº¦</h4>
            <div class="progress-bar-wrapper">
                <div id="progressBar" class="progress-bar">0%</div>
            </div>
            <div class="progress-info">
                <span id="progressText">æº–å‚™ä¸­...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-status">
                <div class="status-item">
                    <span>ç¸½æ•¸:</span>
                    <span class="status-badge total" id="totalCount">0</span>
                </div>
                <div class="status-item">
                    <span>æˆåŠŸ:</span>
                    <span class="status-badge success" id="successCount">0</span>
                </div>
                <div class="status-item">
                    <span>å¤±æ•—:</span>
                    <span class="status-badge failed" id="failedCount">0</span>
                </div>
            </div>
            <div id="progressDetails" class="progress-details"></div>
        </div>
    </div>

    <div class="search-section">
        <h3>æœå°‹ç›®æ¨™å±¬æ€§æ¬„ä½</h3>
        <div class="form-group">
            <label for="targetField">ç›®æ¨™å±¬æ€§æ¬„ä½è®Šæ•¸åç¨±</label>
            <input type="text" id="targetField" placeholder="ä¾‹å¦‚: LimitDateTime æˆ– tw_ID">
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="enrichFromDb" checked>
                å¾è³‡æ–™åº«è‡ªå‹•æ“´å……æ¬„ä½è³‡è¨Š (TWDENS, TWDS, TWCLS, TWIDS)
            </label>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="searchField()">æœå°‹æ¬„ä½</button>
            <button class="btn btn-info" onclick="suggestFromDb()">å¾è³‡æ–™åº«å–å¾—å»ºè­°</button>
        </div>
    </div>

    <div id="searchResultsSection" style="display:none;">
        <div class="search-results">
            <h4>æœå°‹çµæœ <span class="badge badge-count" id="resultCount">0</span></h4>
            <div id="searchResultsList"></div>
        </div>
    </div>

    <div id="resultSection" class="result-section">
        <div class="code-preview">
            <h4>è®Šæ›´å‰çš„åŸç¨‹å¼ç¢¼</h4>
            <div style="color: #666; font-size: 14px; font-style: italic; margin-bottom: 10px;" id="classPath"></div>
            <pre id="originalCode"></pre>
        </div>

        <div id="dbEnrichmentPanel" class="db-info-panel" style="display:none;">
            <h5>è³‡æ–™åº«æ“´å……è³‡è¨Š</h5>
            <div id="dbEnrichmentContent"></div>
        </div>

        <div class="edit-section">
            <h4>ç·¨è¼¯å±¬æ€§æ¬„ä½</h4>
            
            <table class="field-table">
                <thead>
                    <tr>
                        <th style="width: 200px;">æ¬„ä½é¡å‹</th>
                        <th style="width: 150px;">å±¬æ€§åç¨±</th>
                        <th>å±¬æ€§å€¼</th>
                        <th style="width: 100px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="fieldTableBody">
                    <tr class="section-header">
                        <td colspan="4">åŸºæœ¬è³‡è¨Š</td>
                    </tr>
                    <tr class="field-row">
                        <td>ç›®æ¨™å±¬æ€§æ¬„ä½è®Šæ•¸</td>
                        <td>fieldName</td>
                        <td><input type="text" id="edit_fieldName" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">é¡åˆ¥éšå±¤è·¯å¾‘</td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬1å±¤é¡åˆ¥</td>
                        <td>class1</td>
                        <td><input type="text" id="edit_class1" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬2å±¤é¡åˆ¥</td>
                        <td>class2</td>
                        <td><input type="text" id="edit_class2" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬3å±¤é¡åˆ¥</td>
                        <td>class3</td>
                        <td><input type="text" id="edit_class3" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬4å±¤é¡åˆ¥</td>
                        <td>class4</td>
                        <td><input type="text" id="edit_class4" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬5å±¤é¡åˆ¥</td>
                        <td>class5</td>
                        <td><input type="text" id="edit_class5" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">@DSREF è¨»è§£</td>
                    </tr>
                    <tr class="field-row">
                        <td>DSREF</td>
                        <td>den</td>
                        <td><input type="text" id="edit_dsref_den" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>DSREF</td>
                        <td>uid</td>
                        <td><input type="text" id="edit_dsref_uid" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>DSREF</td>
                        <td>cls</td>
                        <td><input type="text" id="edit_dsref_cls" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">TWDENS æ“´å……æ¬„ä½</td>
                    </tr>
                    <tr class="field-row">
                        <td>TWDENS</td>
                        <td>src</td>
                        <td><input type="text" id="edit_twdens_src" placeholder="ä¾‹å¦‚: EDIFACT" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>TWDENS</td>
                        <td>objectClass</td>
                        <td><input type="text" id="edit_twdens_objectClass" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>TWDENS</td>
                        <td>propertyTerm</td>
                        <td><input type="text" id="edit_twdens_propertyTerm" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>TWDENS</td>
                        <td>repTerm</td>
                        <td><input type="text" id="edit_twdens_repTerm" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>TWDENS</td>
                        <td>namedComplexType</td>
                        <td><input type="text" id="edit_twdens_namedComplexType" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">@AAA msg é™£åˆ—</td>
                    </tr>
                </tbody>
            </table>

            <button class="btn btn-add" onclick="addMsgRow()">æ–°å¢ msg é …ç›®</button>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveChanges()">å„²å­˜è®Šæ›´</button>
                <button class="btn btn-primary" onclick="previewCode()">é è¦½è®Šæ›´å¾Œç¨‹å¼ç¢¼</button>
                <label class="checkbox-label" style="margin-left: 10px;">
                    <input type="checkbox" id="syncToDb" checked>
                    åŒæ­¥åˆ°è³‡æ–™åº« (TWDENS)
                </label>
            </div>
        </div>

        <div id="previewSection" class="code-preview" style="display:none; margin-top: 25px;">
            <h4>ğŸ” è®Šæ›´å¾Œç¨‹å¼ç¢¼é è¦½</h4>
            <pre id="previewCode"></pre>
            
            <div id="compareSection" style="margin-top: 15px; display: none;">
                <h5 style="color: #003c75; margin-bottom: 10px;">ğŸ“Š è®Šæ›´å°æ¯”</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong style="color: #dc3545;">è®Šæ›´å‰:</strong>
                        <pre id="compareOriginal" style="background: #fff5f5; border: 1px solid #dc3545;"></pre>
                    </div>
                    <div>
                        <strong style="color: #28a745;">è®Šæ›´å¾Œ:</strong>
                        <pre id="compareNew" style="background: #f0fff4; border: 1px solid #28a745;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentFieldData = null;
let originalFieldData = null;
let msgCounter = 0;
let allSearchResults = [];
let selectedResultIndex = -1;
let fileLoaded = false;

function escapeHtml(text = '') {
    return String(text).replace(/[&<>"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    }[ch]));
}

function formatFileSize(bytes) {
    if (bytes == null || isNaN(bytes)) return '0 B';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function showAlert(message, type = 'info', autoClose = true) {
    const container = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    const alertId = 'alert_' + Date.now();
    
    alertDiv.id = alertId;
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <span class="close-btn" onclick="closeAlert('${alertId}')">&times;</span>
        ${message}
    `;
    
    container.appendChild(alertDiv);
    
    if (autoClose && type !== 'error') {
        setTimeout(() => closeAlert(alertId), 5000);
    }
}

function closeAlert(alertId) {
    const alert = document.getElementById(alertId);
    if (alert) {
        alert.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alert.remove(), 300);
    }
}

function clearAllAlerts() {
    document.getElementById('alertContainer').innerHTML = '';
}

// è¼‰å…¥é è¨­æª”æ¡ˆ
function loadDefaultFile() {
    const loadBtn = document.getElementById('loadBtn');
    loadBtn.disabled = true;
    loadBtn.textContent = 'è¼‰å…¥ä¸­...';

    showAlert('è¼‰å…¥æª”æ¡ˆä¸­... <span class="loading"></span>', 'info', false);

    fetch('/mig/loadDefaultFile', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        clearAllAlerts();
        
        if (data.success) {
            fileLoaded = true;
            
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = data.fileName || 'N/A';
            document.getElementById('filePath').textContent = data.filePath || 'N/A';
            document.getElementById('fileSize').textContent = formatFileSize(data.fileSize);
            document.getElementById('fileLines').textContent = data.lineCount ?? '0';
            document.getElementById('fieldCount').textContent = data.fieldCount ?? '0';
            
            document.getElementById('reloadBtn').style.display = 'inline-block';

            showAlert(
                `âœ… æª”æ¡ˆè¼‰å…¥æˆåŠŸ: ${data.fileName}<br>` +
                `ğŸ“Š è¡Œæ•¸: ${data.lineCount} | æ¬„ä½æ•¸: ${data.fieldCount}<br>` +
                `â±ï¸ è™•ç†æ™‚é–“: ${data.processingTime}ms`, 
                'success'
            );
        } else {
            let msg = 'âŒ è¼‰å…¥å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤');
            
            if (data.errors && data.errors.length) {
                const errorHtml = data.errors.map((e, i) =>
                    `<li><strong>éŒ¯èª¤ ${i+1}:</strong> ${escapeHtml(e)}</li>`
                ).join('');
                
                msg += `<details open style="margin-top:10px;">
                    <summary style="color:#721c24; font-weight:bold; cursor:pointer;">
                        è§£æéŒ¯èª¤åˆ—è¡¨ (${data.errors.length})
                    </summary>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #721c24;">${errorHtml}</ul>
                </details>`;
            }
            
            showAlert(msg, 'error', false);
        }
    })
    .catch(err => {
        clearAllAlerts();
        showAlert('âŒ è¼‰å…¥å¤±æ•—: ' + err.message, 'error', false);
        console.error(err);
    })
    .finally(() => {
        loadBtn.disabled = false;
        loadBtn.textContent = 'è¼‰å…¥æª”æ¡ˆ';
    });
}

// é‡æ–°è¼‰å…¥æª”æ¡ˆ
function reloadFile() {
    if (!confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥æª”æ¡ˆå—ï¼Ÿ\nâš ï¸ æ‰€æœ‰æœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ï¼')) {
        return;
    }
    
    // é‡ç½®ç‹€æ…‹
    fileLoaded = false;
    currentFieldData = null;
    originalFieldData = null;
    allSearchResults = [];
    selectedResultIndex = -1;
    
    document.getElementById('searchResultsSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';
    
    // é‡æ–°è¼‰å…¥
    loadDefaultFile();
}

// æœå°‹æ¬„ä½
function searchField() {
    const targetField = document.getElementById('targetField').value.trim();
    const enrichFromDb = document.getElementById('enrichFromDb').checked;
    
    if (!targetField) {
        showAlert('è«‹è¼¸å…¥ç›®æ¨™å±¬æ€§æ¬„ä½è®Šæ•¸åç¨±', 'error');
        return;
    }

    if (!fileLoaded) {
        showAlert('è«‹å…ˆè¼‰å…¥æª”æ¡ˆ', 'error');
        return;
    }

    showAlert('æœå°‹ä¸­... <span class="loading"></span>', 'info', false);

    const params = new URLSearchParams();
    params.append('fieldName', targetField);
    params.append('enrichFromDb', enrichFromDb);

    fetch('/mig/searchFieldEnhanced', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params
    })
    .then(r => r.json())
    .then(data => {
        clearAllAlerts();
        
        if (data.success) {
            allSearchResults = data.results || [];
            
            if (allSearchResults.length === 0) {
                showAlert(`æ‰¾ä¸åˆ°æ¬„ä½: ${targetField}`, 'warning');
                document.getElementById('searchResultsSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
                return;
            }

            displaySearchResults(allSearchResults);
            showAlert(`âœ… æ‰¾åˆ° ${allSearchResults.length} å€‹åŒ¹é…çš„æ¬„ä½` + 
                     (enrichFromDb ? ' (å·²å¾è³‡æ–™åº«æ“´å……)' : ''), 'success');
        } else {
            showAlert('âŒ æœå°‹å¤±æ•—: ' + data.message, 'error');
        }
    })
    .catch(err => {
        clearAllAlerts();
        showAlert('âŒ æœå°‹å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}

// å¾è³‡æ–™åº«å–å¾—å»ºè­°
function suggestFromDb() {
    const targetField = document.getElementById('targetField').value.trim();
    if (!targetField) {
        showAlert('è«‹è¼¸å…¥æ¬„ä½åç¨±', 'error');
        return;
    }

    showAlert('æŸ¥è©¢è³‡æ–™åº«ä¸­... <span class="loading"></span>', 'info', false);

    const formData = new FormData();
    formData.append('fieldName', targetField);

    fetch('/mig/suggestFromDb', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        clearAllAlerts();
        
        if (data.success && data.suggestion) {
            const suggestion = data.suggestion;
            
            let msg = 'âœ… å¾è³‡æ–™åº«æ‰¾åˆ°å»ºè­°:<br>';
            if (suggestion.dsref && suggestion.dsref.den) msg += `DEN: ${suggestion.dsref.den}<br>`;
            if (suggestion.dsref && suggestion.dsref.cls) msg += `CLS: ${suggestion.dsref.cls}<br>`;
            
            showAlert(msg, 'success');
            
            if (currentFieldData && suggestion.dsref) {
                if (suggestion.dsref.den) {
                    document.getElementById('edit_dsref_den').value = suggestion.dsref.den;
                }
                if (suggestion.dsref.cls) {
                    document.getElementById('edit_dsref_cls').value = suggestion.dsref.cls;
                }
            }
        } else {
            showAlert('âš ï¸ è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Š', 'warning');
        }
    })
    .catch(err => {
        clearAllAlerts();
        showAlert('âŒ æŸ¥è©¢å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}

// æ‰¹æ¬¡åŒ¯å…¥åˆ°è³‡æ–™åº«
function batchImportToDb() {
    if (!fileLoaded) {
        showAlert('è«‹å…ˆè¼‰å…¥æª”æ¡ˆ', 'error');
        return;
    }
    
    if (!confirm('ç¢ºå®šè¦å°‡æª”æ¡ˆä¸­æ‰€æœ‰æ¬„ä½æ‰¹æ¬¡åŒ¯å…¥åˆ°è³‡æ–™åº«å—?\næ­¤æ“ä½œå¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) {
        return;
    }

    const progressContainer = document.getElementById('progressContainer');
    progressContainer.style.display = 'block';

    document.getElementById('progressDetails').innerHTML = '';
    updateProgress(0, 0, 0, 0, 'æ­£åœ¨è™•ç†...');

    fetch('/mig/batchImportToDb', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            updateProgress(
                data.totalFields,
                data.totalFields,
                data.successCount,
                data.failureCount,
                'âœ… æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ!'
            );
            
            addProgressDetail(`ç¸½è¨ˆ: ${data.totalFields} å€‹æ¬„ä½`, 'processing');
            addProgressDetail(`æˆåŠŸ: ${data.successCount} å€‹`, 'success');
            addProgressDetail(`å¤±æ•—: ${data.failureCount} å€‹`, data.failureCount > 0 ? 'error' : 'processing');
            
            if (data.errors && data.errors.length > 0) {
                data.errors.forEach(err => addProgressDetail(`éŒ¯èª¤: ${err}`, 'error'));
            }
            
            const alertType = data.failureCount > 0 ? 'warning' : 'success';
            showAlert(
                `æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ!<br>` +
                `ç¸½æ¬„ä½æ•¸: ${data.totalFields}<br>` +
                `âœ… æˆåŠŸ: ${data.successCount}<br>` +
                `âŒ å¤±æ•—: ${data.failureCount}`,
                alertType
            );
        } else {
            showAlert('âŒ æ‰¹æ¬¡åŒ¯å…¥å¤±æ•—: ' + data.message, 'error');
        }
    })
    .catch(err => {
        showAlert('âŒ æ‰¹æ¬¡åŒ¯å…¥å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}

function updateProgress(current, total, success, failed, message) {
    const percent = total > 0 ? Math.round((current / total) * 100) : 0;
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';

    if (percent === 100) {
        progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    } else {
        progressBar.style.background = 'linear-gradient(90deg, #2196f3, #64b5f6)';
    }

    document.getElementById('progressText').textContent = message;
    document.getElementById('progressPercent').textContent = `${current} / ${total}`;
    document.getElementById('totalCount').textContent = total;
    document.getElementById('successCount').textContent = success;
    document.getElementById('failedCount').textContent = failed;
}

function addProgressDetail(message, type) {
    const details = document.getElementById('progressDetails');
    const div = document.createElement('div');
    div.className = type === 'success' ? 'success-item' :
                   type === 'error' ? 'error-item' : 'processing-item';
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });

    div.textContent = `[${timeStr}] ${message}`;
    details.appendChild(div);
    details.scrollTop = details.scrollHeight;
}

// é¡¯ç¤ºæœå°‹çµæœ
function displaySearchResults(results) {
    const resultsList = document.getElementById('searchResultsList');
    const resultCount = document.getElementById('resultCount');
    resultsList.innerHTML = '';
    resultCount.textContent = results.length;

    results.forEach((result, index) => {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.onclick = () => selectResult(index);
        
        const classPathStr = result.classPath && result.classPath.length > 0 
            ? result.classPath.join(' â†’ ') 
            : '(æ ¹å±¤ç´š)';
        
        let dbInfo = '';
        if (result.dbEnrichment) {
            const db = result.dbEnrichment;
            if (db.xmlTagName || db.objectClass || db.classHierarchy) {
                dbInfo = `<div class="db-enrichment">
                    <strong>è³‡æ–™åº«è³‡è¨Š:</strong> 
                    ${db.xmlTagName ? `XML Tag: ${db.xmlTagName}` : ''}
                    ${db.objectClass ? ` | Object Class: ${db.objectClass}` : ''}
                    ${db.classHierarchy && db.classHierarchy.length > 0 ? 
                        ` | é¡åˆ¥æ•¸: ${db.classHierarchy.length}` : ''}
                </div>`;
            }
        }
        
        item.innerHTML = `
            <div class="result-item-header">
                <div class="result-item-title">
                    ${escapeHtml(result.fieldName)}
                    <span class="badge badge-count">#${index + 1}</span>
                    ${result.dbEnrichment ? '<span class="badge badge-success">å·²æ“´å……</span>' : ''}
                </div>
            </div>
            <div class="result-item-path">
                é¡åˆ¥è·¯å¾‘: ${escapeHtml(classPathStr)}
            </div>
            <div class="result-item-code">${escapeHtml(result.originalCode)}</div>
            ${dbInfo}
        `;
        
        resultsList.appendChild(item);
    });

    document.getElementById('searchResultsSection').style.display = 'block';
}

// é¸æ“‡æœå°‹çµæœ
function selectResult(index) {
    selectedResultIndex = index;
    currentFieldData = JSON.parse(JSON.stringify(allSearchResults[index]));
    originalFieldData = JSON.parse(JSON.stringify(allSearchResults[index]));
    
    document.querySelectorAll('.result-item').forEach((item, i) => {
        if (i === index) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });

    displayFieldData();
    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
}

// é¡¯ç¤ºæ¬„ä½è³‡æ–™
function displayFieldData() {
    if (!currentFieldData) return;
    
    document.getElementById('resultSection').style.display = 'block';

    const classPathStr = currentFieldData.classPath && currentFieldData.classPath.length > 0 
        ? currentFieldData.classPath.join(' â†’ ') 
        : '(æ ¹å±¤ç´š)';
    document.getElementById('classPath').textContent = `é¡åˆ¥è·¯å¾‘: ${classPathStr}`;
    document.getElementById('originalCode').textContent = currentFieldData.originalCode;

    document.getElementById('edit_fieldName').value = currentFieldData.fieldName || '';

    for (let i = 1; i <= 5; i++) {
        const classValue = currentFieldData.classPath && currentFieldData.classPath[i - 1] 
            ? currentFieldData.classPath[i - 1] : '';
        document.getElementById(`edit_class${i}`).value = classValue;
    }

    if (currentFieldData.dsref) {
        document.getElementById('edit_dsref_den').value = currentFieldData.dsref.den || '';
        document.getElementById('edit_dsref_uid').value = currentFieldData.dsref.uid || '';
        document.getElementById('edit_dsref_cls').value = currentFieldData.dsref.cls || '';
    }

    if (currentFieldData.dbEnrichment) {
        displayDbEnrichment(currentFieldData.dbEnrichment);
        
        document.getElementById('edit_twdens_src').value = currentFieldData.dbEnrichment.src || '';
        document.getElementById('edit_twdens_objectClass').value = currentFieldData.dbEnrichment.objectClass || '';
        document.getElementById('edit_twdens_propertyTerm').value = currentFieldData.dbEnrichment.propertyTerm || '';
        document.getElementById('edit_twdens_repTerm').value = currentFieldData.dbEnrichment.repTerm || '';
        document.getElementById('edit_twdens_namedComplexType').value = currentFieldData.dbEnrichment.namedComplexType || '';
    } else {
        document.getElementById('dbEnrichmentPanel').style.display = 'none';
    }

    rebuildMsgRows();
}

// é¡¯ç¤ºè³‡æ–™åº«æ“´å……è³‡è¨Š
function displayDbEnrichment(dbEnrichment) {
    const panel = document.getElementById('dbEnrichmentPanel');
    const content = document.getElementById('dbEnrichmentContent');
    let html = '';

    if (dbEnrichment.xmlTagName || dbEnrichment.objectClass || dbEnrichment.src) {
        html += `<div class="db-info-item"><strong>TWDENS:</strong></div>`;
        if (dbEnrichment.src) {
            html += `<div class="db-info-item">&nbsp;&nbsp;SRC: ${escapeHtml(dbEnrichment.src)}</div>`;
        }
        if (dbEnrichment.xmlTagName) {
            html += `<div class="db-info-item">&nbsp;&nbsp;XML Tag Name: ${escapeHtml(dbEnrichment.xmlTagName)}</div>`;
        }
        if (dbEnrichment.objectClass) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Object Class: ${escapeHtml(dbEnrichment.objectClass)}</div>`;
        }
        if (dbEnrichment.propertyTerm) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Property Term: ${escapeHtml(dbEnrichment.propertyTerm)}</div>`;
        }
        if (dbEnrichment.repTerm) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Rep Term: ${escapeHtml(dbEnrichment.repTerm)}</div>`;
        }
        if (dbEnrichment.namedComplexType) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Named Complex Type: ${escapeHtml(dbEnrichment.namedComplexType)}</div>`;
        }
    }

    if (dbEnrichment.classHierarchy && dbEnrichment.classHierarchy.length > 0) {
        html += `<div class="db-info-item" style="margin-top:10px;"><strong>TWCLS é¡åˆ¥éšå±¤ (${dbEnrichment.classHierarchy.length}):</strong></div>`;
        dbEnrichment.classHierarchy.forEach((cls, idx) => {
            html += `<div class="db-info-item">&nbsp;&nbsp;${idx + 1}. ${escapeHtml(cls.className || cls.objectClass)}`;
            if (cls.chName) html += ` (${escapeHtml(cls.chName)})`;
            html += `</div>`;
        });
    }

    if (html) {
        content.innerHTML = html;
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

// MSG åˆ—ç®¡ç†
function rebuildMsgRows() {
    const tbody = document.getElementById('fieldTableBody');
    const existingMsgRows = tbody.querySelectorAll('.msg-row');
    existingMsgRows.forEach(row => row.remove());

    msgCounter = 0;

    if (!currentFieldData.aaa) currentFieldData.aaa = { msg: [] };
    if (!currentFieldData.aaa.msg || currentFieldData.aaa.msg.length === 0) {
        currentFieldData.aaa.msg.push({ name: '', car: '', boro: '', chn: '' });
    }

    currentFieldData.aaa.msg.forEach((msg, index) => {
        addMsgRowWithData(msg, index);
    });
}

function addMsgRowWithData(msgData, index) {
    const tbody = document.getElementById('fieldTableBody');
    const id = msgCounter++;
    const rows = [
        createMsgRow('AAA msg', 'name', id, msgData.name, index === 0),
        createMsgRow('AAA msg', 'car', id, msgData.car, false),
        createMsgRow('AAA msg', 'boro', id, msgData.boro, false),
        createMsgRow('AAA msg', 'chn', id, msgData.chn, false)
    ];

    rows.forEach(row => tbody.appendChild(row));
}

function addMsgRow() {
    const msgData = { name: '', car: '', boro: '', chn: '' };
    addMsgRowWithData(msgData, currentFieldData.aaa.msg.length);
    currentFieldData.aaa.msg.push(msgData);
}

function createMsgRow(type, field, id, value, showDelete) {
    const tr = document.createElement('tr');
    tr.className = 'field-row msg-row';
    tr.setAttribute('data-msg-id', id);
    tr.setAttribute('data-msg-field', field);
    tr.innerHTML = `
        <td>${escapeHtml(type)}</td>
        <td>${escapeHtml(field)}</td>
        <td><input type="text" value="${escapeHtml(value || '')}" data-msg-id="${id}" data-field="${field}" /></td>
        <td>${showDelete ? `<button class="btn btn-danger" onclick="deleteMsgRow(${id})">åˆªé™¤</button>` : ''}</td>
    `;
    return tr;
}

function deleteMsgRow(msgId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ msg é …ç›®å—?')) return;
    
    const rows = document.querySelectorAll(`[data-msg-id="${msgId}"]`);
    rows.forEach(row => row.remove());
    collectFormData();
}

// æ”¶é›†è¡¨å–®è³‡æ–™
function collectFormData() {
    currentFieldData.fieldName = document.getElementById('edit_fieldName').value;
    currentFieldData.classPath = [];
    
    for (let i = 1; i <= 5; i++) {
        const classValue = document.getElementById(`edit_class${i}`).value.trim();
        if (classValue) {
            currentFieldData.classPath.push(classValue);
        }
    }

    if (!currentFieldData.dsref) currentFieldData.dsref = {};
    currentFieldData.dsref.den = document.getElementById('edit_dsref_den').value;
    currentFieldData.dsref.uid = document.getElementById('edit_dsref_uid').value;
    currentFieldData.dsref.cls = document.getElementById('edit_dsref_cls').value;

    if (!currentFieldData.dbEnrichment) currentFieldData.dbEnrichment = {};
    currentFieldData.dbEnrichment.src = document.getElementById('edit_twdens_src').value;
    currentFieldData.dbEnrichment.objectClass = document.getElementById('edit_twdens_objectClass').value;
    currentFieldData.dbEnrichment.propertyTerm = document.getElementById('edit_twdens_propertyTerm').value;
    currentFieldData.dbEnrichment.repTerm = document.getElementById('edit_twdens_repTerm').value;
    currentFieldData.dbEnrichment.namedComplexType = document.getElementById('edit_twdens_namedComplexType').value;
    currentFieldData.dbEnrichment.xmlTagName = currentFieldData.fieldName;

    const msgMap = new Map();
    const inputs = document.querySelectorAll('.msg-row input');

    inputs.forEach(input => {
        const msgId = input.getAttribute('data-msg-id');
        const field = input.getAttribute('data-field');
        
        if (!msgMap.has(msgId)) {
            msgMap.set(msgId, {});
        }
        
        msgMap.get(msgId)[field] = input.value;
    });

    if (!currentFieldData.aaa) currentFieldData.aaa = {};
    currentFieldData.aaa.msg = Array.from(msgMap.values());
}

// é è¦½ç¨‹å¼ç¢¼
function previewCode() {
    collectFormData();
    const newCode = generateFieldCode(currentFieldData);
    const originalCode = currentFieldData.originalCode;

    document.getElementById('previewCode').textContent = newCode;
    document.getElementById('previewSection').style.display = 'block';

    const hasChanges = newCode !== originalCode;

    if (hasChanges) {
        document.getElementById('compareSection').style.display = 'block';
        document.getElementById('compareOriginal').textContent = originalCode;
        document.getElementById('compareNew').textContent = newCode;
    } else {
        document.getElementById('compareSection').style.display = 'none';
        showAlert('â„¹ï¸ æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•è®Šæ›´', 'info');
    }

    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function generateFieldCode(data) {
    const msgLines = data.aaa && data.aaa.msg ? data.aaa.msg.map(msg =>
        `        "name=${msg.name || ''},car=${msg.car || ''},boro=${msg.boro || ''},chn=${msg.chn || ''}"`
    ).join(',\n') : '';
    
    return `    @DSREF(den = "${data.dsref?.den || ''}", uid = "${data.dsref?.uid || ''}", cls = "${data.dsref?.cls || ''}")
    @AAA(msg = {
${msgLines}
    })
    public String ${data.fieldName || ''};`;
}

// å„²å­˜è®Šæ›´
function saveChanges() {
    if (!confirm('ç¢ºå®šè¦å„²å­˜è®Šæ›´å—ï¼Ÿ\nè®Šæ›´å°‡å›å­˜åˆ°åŸæª”æ¡ˆä½ç½®åŠè¨­å®šçš„åŒæ­¥è·¯å¾‘ã€‚')) return;
    
    collectFormData();

    const syncToDb = document.getElementById('syncToDb').checked;

    const saveData = {
        syncToDb: syncToDb,
        fieldData: currentFieldData
    };

    showAlert('å„²å­˜ä¸­... <span class="loading"></span>', 'info', false);

    fetch('/mig/updateFieldEnhanced', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saveData)
    })
    .then(r => r.json())
    .then(res => {
        clearAllAlerts();
        
        if (res.success) {
            let msg = 'âœ… è®Šæ›´å·²æˆåŠŸå„²å­˜!';
            if (res.backupPath) {
                msg += `<br>ğŸ“ å‚™ä»½æª”æ¡ˆ: ${escapeHtml(res.backupPath)}`;
            }
            if (res.filePath) {
                msg += `<br>ğŸ’¾ å·²å›å­˜è‡³: ${escapeHtml(res.filePath)}`;
            }
            // é¡¯ç¤ºåŒæ­¥è·¯å¾‘
            if (res.syncedPaths && res.syncedPaths.length > 0) {
                msg += `<br>ğŸ”„ åŒæ­¥è·¯å¾‘ (${res.syncedPaths.length}):`;
                res.syncedPaths.forEach(path => {
                    msg += `<br>&nbsp;&nbsp;âœ“ ${escapeHtml(path)}`;
                });
            }
            if (res.dbSynced) {
                msg += '<br>ğŸ’¾ è³‡æ–™å·²åŒæ­¥è‡³è³‡æ–™åº«';
            } else if (syncToDb && res.dbSyncError) {
                msg += `<br>âš ï¸ è³‡æ–™åº«åŒæ­¥è­¦å‘Š: ${escapeHtml(res.dbSyncError)}`;
            }
            
            showAlert(msg, 'success');
            
            originalFieldData = JSON.parse(JSON.stringify(currentFieldData));
            document.getElementById('originalCode').textContent = currentFieldData.originalCode;
            
            if (selectedResultIndex >= 0) {
                allSearchResults[selectedResultIndex] = JSON.parse(JSON.stringify(currentFieldData));
                displaySearchResults(allSearchResults);
            }
            
            document.getElementById('previewSection').style.display = 'none';
        } else {
            showAlert('âŒ å„²å­˜å¤±æ•—: ' + res.message, 'error');
        }
    })
    .catch(err => {
        clearAllAlerts();
        showAlert('âŒ å„²å­˜å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}
</script>
</body>
</html>