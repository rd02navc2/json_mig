<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å±¬æ€§æ¬„ä½ç¶­è­·ç·¨è¼¯ç³»çµ± (è³‡æ–™åº«æ•´åˆç‰ˆ)</title>
<style>
body {
    font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ===== å´é‚Šæ¬„ ===== */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 240px;
    height: 100vh;
    background: #fafafa !important;
    color: #1a1a1a !important;
    overflow-y: auto;
    z-index: 1000;
    border-right: 1px solid #e0e0e0 !important;
    box-shadow: 2px 0 8px rgba(0,0,0,0.04);
}

.sidebar-header {
    padding: 20px 18px;
    background: #ffffff !important;
    border-bottom: 1px solid #e0e0e0 !important;
}

.sidebar-header h4 {
    font-size: 14px;
    font-weight: 500;
    margin: 0;
    line-height: 1.4;
    color: #1a1a1a !important;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.sidebar-menu {
    list-style: none;
    padding: 4px 0;
    margin: 0;
}

.sidebar-menu li {
    margin: 0;
}

.sidebar-menu a {
    display: block;
    padding: 12px 18px;
    color: #4a4a4a !important;
    text-decoration: none;
    border-left: 2px solid transparent;
    transition: all 0.15s ease;
    font-size: 15px;
    font-weight: 400;
}

.sidebar-menu a:hover {
    background: #f0f0f0 !important;
    color: #1a1a1a !important;
    border-left-color: #bdbdbd !important;
}

.sidebar-menu a.active {
    background: #ffffff !important;
    color: #1a1a1a !important;
    border-left-color: #1a1a1a !important;
    font-weight: 500;
}

h1 {
    color: #003c75;
    border-bottom: 3px solid #003c75;
    padding-bottom: 10px;
    margin-top: 0;
}

.upload-section {
    background: #e3f2fd;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 25px;
    border: 2px dashed #2196f3;
}

.upload-section h3 {
    margin-top: 0;
    color: #1976d2;
}

.search-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 25px;
    border: 1px solid #ddd;
}

.search-section h3 {
    margin-top: 0;
    color: #003c75;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-group input[type="text"],
.form-group input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 15px;
    box-sizing: border-box;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.checkbox-label {
    font-weight: normal;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
}

.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #003c75;
    color: white;
}

.btn-primary:hover {
    background: #002a63;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-danger {
    background: #dc3545;
    color: white;
    padding: 6px 12px;
    font-size: 14px;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-add {
    background: #17a2b8;
    color: white;
    margin-top: 10px;
}

.btn-add:hover {
    background: #138496;
}

.btn-upload {
    background: #2196f3;
    color: white;
}

.btn-upload:hover {
    background: #1976d2;
}

.btn-info {
    background: #17a2b8;
    color: white;
    padding: 8px 20px;
    font-size: 14px;
}

.btn-info:hover {
    background: #138496;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.result-section {
    display: none;
    margin-top: 30px;
}

.search-results {
    background: #fff3cd;
    padding: 20px;
    border-radius: 6px;
    border: 1px solid #ffc107;
    margin-bottom: 25px;
}

.search-results h4 {
    margin-top: 0;
    color: #856404;
}

.result-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.result-item:hover {
    background: #f0f0f0;
    border-color: #003c75;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.result-item.selected {
    background: #e3f2fd;
    border: 2px solid #2196f3;
}

.result-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.result-item-title {
    font-weight: bold;
    font-size: 16px;
    color: #003c75;
}

.result-item-path {
    font-size: 13px;
    color: #666;
    margin-bottom: 10px;
}

.result-item-code {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    white-space: pre-wrap;
    border: 1px solid #dee2e6;
}

.db-enrichment {
    background: #e8f5e9;
    padding: 10px;
    margin-top: 10px;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid #4caf50;
}

.db-enrichment strong {
    color: #2e7d32;
}

.code-preview {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    margin-bottom: 25px;
}

.code-preview h4 {
    margin-top: 0;
    color: #003c75;
}

.code-preview pre {
    background: #ffffff;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #ddd;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
}

.edit-section {
    background: #ffffff;
    padding: 20px;
    border-radius: 6px;
    border: 2px solid #003c75;
}

.edit-section h4 {
    margin-top: 0;
    color: #003c75;
    border-bottom: 2px solid #003c75;
    padding-bottom: 8px;
}

.field-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.field-table th {
    background: #003c75;
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: bold;
}

.field-table td {
    padding: 10px;
    border: 1px solid #ddd;
}

.field-table tr:nth-child(even) {
    background: #f9f9f9;
}

.field-table input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    box-sizing: border-box;
}

.field-row {
    background: white;
}

.field-row:hover {
    background: #f0f0f0;
}

.section-header {
    background: #e9ecef;
    font-weight: bold;
    color: #003c75;
}

.action-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}

.file-info {
    background: white;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    border: 1px solid #ccc;
}

.class-path {
    color: #666;
    font-size: 14px;
    font-style: italic;
    margin-top: 5px;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}

.badge-count {
    background: #ffc107;
    color: #000;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-info {
    background: #17a2b8;
    color: white;
}

.hierarchy-label {
    color: #666;
    font-size: 13px;
    margin-bottom: 3px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,.1);
    border-radius: 50%;
    border-top-color: #003c75;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.db-info-panel {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid #b3d9ff;
}

.db-info-panel h5 {
    margin-top: 0;
    color: #003c75;
    font-size: 14px;
}

.db-info-item {
    margin-bottom: 8px;
    font-size: 13px;
}

.db-info-item strong {
    color: #003c75;
}

.batch-actions {
    background: #fff9e6;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 25px;
    border: 1px solid #ffd966;
}

.batch-actions h3 {
    margin-top: 0;
    color: #856404;
    font-size: 16px;
}

/* ===== é€²åº¦æ¢æ¨£å¼ ===== */
.progress-container {
    display: none;
    background: white;
    padding: 20px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid #ddd;
}

.progress-bar-wrapper {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    margin: 15px 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 14px;
}

.progress-status {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.status-badge.total {
    background: #e3f2fd;
    color: #1976d2;
}

.status-badge.success {
    background: #d4edda;
    color: #155724;
}

.status-badge.failed {
    background: #f8d7da;
    color: #721c24;
}

.status-badge.processing {
    background: #fff3cd;
    color: #856404;
}

.progress-details {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 13px;
    font-family: 'Courier New', monospace;
}

.progress-details div {
    padding: 3px 0;
    border-bottom: 1px solid #e0e0e0;
}

.progress-details div:last-child {
    border-bottom: none;
}

.progress-details .success-item {
    color: #28a745;
}

.progress-details .error-item {
    color: #dc3545;
}

.progress-details .processing-item {
    color: #856404;
}
</style>
</head>
<body>
<div class="layout">
    <!-- å´é‚Šæ¬„ -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="container">
    <h1>å±¬æ€§æ¬„ä½ç¶­è­·ç·¨è¼¯ç³»çµ± <span class="badge badge-info">è³‡æ–™åº«æ•´åˆç‰ˆ</span></h1>
    
    <!-- æª”æ¡ˆä¸Šå‚³å€å¡Š -->
    <div class="upload-section">
        <h3>ä¸Šå‚³ Java æª”æ¡ˆ</h3>
        <div class="form-group">
            <label for="javaFile">é¸æ“‡ MyMapping.java æª”æ¡ˆ</label>
            <input type="file" id="javaFile" accept=".java" onchange="handleFileUpload(event)">
        </div>
        <button class="btn btn-upload" onclick="uploadFile()">ä¸Šå‚³æª”æ¡ˆ</button>
        <div id="fileInfo" class="file-info" style="display:none;">
            <strong>å·²è¼‰å…¥æª”æ¡ˆ:</strong> <span id="fileName"></span><br>
            <strong>æª”æ¡ˆå¤§å°:</strong> <span id="fileSize"></span><br>
            <strong>ç¸½è¡Œæ•¸:</strong> <span id="fileLines"></span>
        </div>
    </div>

    <!-- æ‰¹æ¬¡æ“ä½œå€å¡Š -->
    <div class="batch-actions">
        <h3>æ‰¹æ¬¡æ“ä½œ</h3>
        <button class="btn btn-secondary" onclick="batchImportToDb()">æ‰¹æ¬¡åŒ¯å…¥æ‰€æœ‰æ¬„ä½åˆ°è³‡æ–™åº«</button>
        <p style="font-size: 13px; color: #666; margin-top: 10px;">
            âš ï¸ æ­¤æ“ä½œæœƒå°‡æª”æ¡ˆä¸­æ‰€æœ‰å¸¶æœ‰ @DSREF è¨»è§£çš„æ¬„ä½åŒæ­¥åˆ°è³‡æ–™åº«
        </p>
        
        <!-- é€²åº¦æ¢ -->
        <div id="progressContainer" class="progress-container">
            <h4 style="margin-top: 0; color: #003c75;">åŒ¯å…¥é€²åº¦</h4>
            <div class="progress-bar-wrapper">
                <div id="progressBar" class="progress-bar">0%</div>
            </div>
            <div class="progress-info">
                <span id="progressText">æº–å‚™ä¸­...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-status">
                <div class="status-item">
                    <span>ç¸½æ•¸:</span>
                    <span class="status-badge total" id="totalCount">0</span>
                </div>
                <div class="status-item">
                    <span>æˆåŠŸ:</span>
                    <span class="status-badge success" id="successCount">0</span>
                </div>
                <div class="status-item">
                    <span>å¤±æ•—:</span>
                    <span class="status-badge failed" id="failedCount">0</span>
                </div>
                <div class="status-item">
                    <span>è™•ç†ä¸­:</span>
                    <span class="status-badge processing" id="processingField">-</span>
                </div>
            </div>
            <div id="progressDetails" class="progress-details"></div>
        </div>
    </div>

    <div class="search-section">
        <h3>æœå°‹ç›®æ¨™å±¬æ€§æ¬„ä½</h3>
        <div class="form-group">
            <label for="targetField">ç›®æ¨™å±¬æ€§æ¬„ä½è®Šæ•¸åç¨±</label>
            <input type="text" id="targetField" placeholder="ä¾‹å¦‚: LimitDateTime æˆ– tw_ID">
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="enrichFromDb" checked>
                å¾è³‡æ–™åº«è‡ªå‹•æ“´å……æ¬„ä½è³‡è¨Š (TWDENS, TWDS, TWCLS, TWIDS)
            </label>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="searchField()">éè¿´æœå°‹æ¬„ä½</button>
            <button class="btn btn-info" onclick="suggestFromDb()">å¾è³‡æ–™åº«å–å¾—å»ºè­°</button>
        </div>
    </div>

    <div id="searchResultsSection" style="display:none;">
        <div class="search-results">
            <h4>æœå°‹çµæœ <span class="badge badge-count" id="resultCount">0</span></h4>
            <div id="searchResultsList"></div>
        </div>
    </div>

    <div id="resultSection" class="result-section">
        <!-- æç¤ºè¨Šæ¯ -->
        <div id="alertBox"></div>

        <!-- åŸå§‹ç¨‹å¼ç¢¼é è¦½ -->
        <div class="code-preview">
            <h4>åŸå§‹ç¨‹å¼ç¢¼</h4>
            <div class="class-path" id="classPath"></div>
            <pre id="originalCode"></pre>
        </div>

        <!-- è³‡æ–™åº«æ“´å……è³‡è¨Š -->
        <div id="dbEnrichmentPanel" class="db-info-panel" style="display:none;">
            <h5>ğŸ“Š è³‡æ–™åº«æ“´å……è³‡è¨Š</h5>
            <div id="dbEnrichmentContent"></div>
        </div>

        <div class="edit-section">
            <h4>âœï¸ ç·¨è¼¯å±¬æ€§æ¬„ä½</h4>
            
            <table class="field-table">
                <thead>
                    <tr>
                        <th style="width: 200px;">æ¬„ä½é¡å‹</th>
                        <th style="width: 150px;">å±¬æ€§åç¨±</th>
                        <th>å±¬æ€§å€¼</th>
                        <th style="width: 100px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="fieldTableBody">
                    <tr class="section-header">
                        <td colspan="4">åŸºæœ¬è³‡è¨Š</td>
                    </tr>
                    <tr class="field-row">
                        <td>ç›®æ¨™å±¬æ€§æ¬„ä½è®Šæ•¸</td>
                        <td>fieldName (xmlTagName)</td>
                        <td><input type="text" id="edit_fieldName" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">é¡åˆ¥éšå±¤è·¯å¾‘ (Object Class, æœ€å¤š5å±¤)</td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬1å±¤é¡åˆ¥</td>
                        <td>class1 (objectClass)</td>
                        <td><input type="text" id="edit_class1" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬2å±¤é¡åˆ¥</td>
                        <td>class2</td>
                        <td><input type="text" id="edit_class2" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬3å±¤é¡åˆ¥</td>
                        <td>class3</td>
                        <td><input type="text" id="edit_class3" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬4å±¤é¡åˆ¥</td>
                        <td>class4</td>
                        <td><input type="text" id="edit_class4" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>ç¬¬5å±¤é¡åˆ¥</td>
                        <td>class5</td>
                        <td><input type="text" id="edit_class5" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">@DSREF è¨»è§£</td>
                    </tr>
                    <tr class="field-row">
                        <td>DSREF</td>
                        <td>den (TWDENS.den)</td>
                        <td><input type="text" id="edit_dsref_den" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>DSREF</td>
                        <td>uid (TWIDS.twid)</td>
                        <td><input type="text" id="edit_dsref_uid" /></td>
                        <td></td>
                    </tr>
                    <tr class="field-row">
                        <td>DSREF</td>
                        <td>cls (TWCLS.className)</td>
                        <td><input type="text" id="edit_dsref_cls" /></td>
                        <td></td>
                    </tr>

                    <tr class="section-header">
                        <td colspan="4">@AAA msg é™£åˆ—</td>
                    </tr>
                </tbody>
            </table>

            <button class="btn btn-add" onclick="addMsgRow()">æ–°å¢ msg é …ç›®</button>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveChanges()">å„²å­˜è®Šæ›´</button>
                <button class="btn btn-primary" onclick="previewCode()">é è¦½ç¨‹å¼ç¢¼</button>
                <label class="checkbox-label" style="margin-left: 10px;">
                    <input type="checkbox" id="syncToDb" checked>
                    åŒæ­¥åˆ°è³‡æ–™åº« (TWDENS)
                </label>
            </div>
        </div>

        <div id="previewSection" class="code-preview" style="display:none; margin-top: 25px;">
            <h4>è®Šæ›´å¾Œç¨‹å¼ç¢¼é è¦½</h4>
            <pre id="previewCode"></pre>
        </div>
    </div>
</div>
</div>

<script>
// å…¨åŸŸè®Šæ•¸
let currentFieldData = null;
let msgCounter = 0;
let javaFileContent = '';
let allSearchResults = [];
let selectedResultIndex = -1;

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        javaFileContent = e.target.result;
        const lines = javaFileContent.split('\n').length;
        
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('fileLines').textContent = lines;
        
        showAlert(`æª”æ¡ˆè¼‰å…¥æˆåŠŸ: ${file.name} (${lines} è¡Œ)`, 'success');
    };
    reader.readAsText(file);
}

function uploadFile() {
    const fileInput = document.getElementById('javaFile');
    if (!fileInput.files.length) {
        showAlert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ', 'error');
        return;
    }
    showAlert('æª”æ¡ˆå·²æº–å‚™å°±ç·’,å¯ä»¥é–‹å§‹æœå°‹', 'success');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ===== ä¸»è¦æœå°‹åŠŸèƒ½ (æ•´åˆè³‡æ–™åº«) =====
function searchField() {
    const targetField = document.getElementById('targetField').value.trim();
    const enrichFromDb = document.getElementById('enrichFromDb').checked;
    
    if (!targetField) {
        showAlert('è«‹è¼¸å…¥ç›®æ¨™å±¬æ€§æ¬„ä½è®Šæ•¸åç¨±', 'error');
        return;
    }

    if (!javaFileContent) {
        showAlert('è«‹å…ˆä¸Šå‚³ Java æª”æ¡ˆ', 'error');
        return;
    }

    showAlert('æœå°‹ä¸­... <span class="loading"></span>', 'info');

    // æº–å‚™è¡¨å–®æ•¸æ“š
    const formData = new FormData();
    formData.append('fieldName', targetField);
    formData.append('fileName', document.getElementById('fileName').textContent || '');
    formData.append('enrichFromDb', enrichFromDb);

    fetch('/mig/searchFieldEnhanced', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            allSearchResults = data.results || [];
            
            if (allSearchResults.length === 0) {
                showAlert(`æ‰¾ä¸åˆ°æ¬„ä½: ${targetField}`, 'error');
                document.getElementById('searchResultsSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
                return;
            }

            displaySearchResults(allSearchResults);
            showAlert(`æ‰¾åˆ° ${allSearchResults.length} å€‹åŒ¹é…çš„æ¬„ä½` + 
                     (enrichFromDb ? ' (å·²å¾è³‡æ–™åº«æ“´å……)' : ''), 'success');
        } else {
            showAlert('æœå°‹å¤±æ•—: ' + data.message, 'error');
        }
    })
    .catch(err => {
        showAlert('æœå°‹å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}

// ===== å¾è³‡æ–™åº«å–å¾—å»ºè­° =====
function suggestFromDb() {
    const targetField = document.getElementById('targetField').value.trim();
    
    if (!targetField) {
        showAlert('è«‹è¼¸å…¥æ¬„ä½åç¨±', 'error');
        return;
    }

    showAlert('æŸ¥è©¢è³‡æ–™åº«ä¸­... <span class="loading"></span>', 'info');

    const formData = new FormData();
    formData.append('fieldName', targetField);

    fetch('/mig/suggestFromDb', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.suggestion) {
            const suggestion = data.suggestion;
            
            // é¡¯ç¤ºå»ºè­°è³‡è¨Š
            let msg = `å¾è³‡æ–™åº«æ‰¾åˆ°å»ºè­°:\n`;
            if (suggestion.dsref.den) msg += `DEN: ${suggestion.dsref.den}\n`;
            if (suggestion.dsref.cls) msg += `CLS: ${suggestion.dsref.cls}\n`;
            
            showAlert(msg.replace(/\n/g, '<br>'), 'success');
            
            // å¡«å……åˆ°ç•¶å‰ç·¨è¼¯å€ (å¦‚æœæœ‰é–‹å•Ÿ)
            if (currentFieldData) {
                if (suggestion.dsref.den) {
                    document.getElementById('edit_dsref_den').value = suggestion.dsref.den;
                }
                if (suggestion.dsref.cls) {
                    document.getElementById('edit_dsref_cls').value = suggestion.dsref.cls;
                }
            }
        } else {
            showAlert('è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Š', 'warning');
        }
    })
    .catch(err => {
        showAlert('æŸ¥è©¢å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}

// ===== æ‰¹æ¬¡åŒ¯å…¥åˆ°è³‡æ–™åº« (å¸¶é€²åº¦é¡¯ç¤º) =====
function batchImportToDb() {
    if (!javaFileContent) {
        showAlert('è«‹å…ˆä¸Šå‚³ Java æª”æ¡ˆ', 'error');
        return;
    }

    if (!confirm('ç¢ºå®šè¦å°‡æª”æ¡ˆä¸­æ‰€æœ‰æ¬„ä½æ‰¹æ¬¡åŒ¯å…¥åˆ°è³‡æ–™åº«å—?\næ­¤æ“ä½œå¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) {
        return;
    }

    // é¡¯ç¤ºé€²åº¦å®¹å™¨
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.style.display = 'block';
    
    // æ¸…ç©ºè©³ç´°è³‡è¨Š
    document.getElementById('progressDetails').innerHTML = '';
    
    // åˆå§‹åŒ–é€²åº¦
    updateProgress(0, 0, 0, 0, 'æ­£åœ¨è§£ææª”æ¡ˆ...');
    
    // å…ˆåœ¨å‰ç«¯è§£ææ‰€æœ‰æ¬„ä½
    const allFields = findAllFieldsInContent(javaFileContent);
    
    if (allFields.length === 0) {
        showAlert('æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°å¸¶æœ‰ @DSREF è¨»è§£çš„æ¬„ä½', 'warning');
        progressContainer.style.display = 'none';
        return;
    }

    addProgressDetail(`ğŸ“‹ æ‰¾åˆ° ${allFields.length} å€‹æ¬„ä½,é–‹å§‹åŒ¯å…¥...`, 'processing');
    updateProgress(0, allFields.length, 0, 0, 'æº–å‚™åŒ¯å…¥...');
    
    // æ‰¹æ¬¡è™•ç† (æ¯æ¬¡è™•ç†ä¸€å€‹,é¡¯ç¤ºé€²åº¦)
    batchProcessFields(allFields, 0, 0, 0);
}

function findAllFieldsInContent(content) {
    const results = [];
    const lines = content.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        // æª¢æŸ¥æ˜¯å¦ç‚º public æ¬„ä½å®£å‘Š
        const fieldPattern = /(?:public|private|protected)\s+\w+\s+(\w+)\s*[;=]/;
        
        if (fieldPattern.test(line)) {
            // æª¢æŸ¥å‰é¢æ˜¯å¦æœ‰ @DSREF è¨»è§£
            let hasDsref = false;
            for (let j = Math.max(0, i - 10); j < i; j++) {
                if (lines[j].trim().startsWith('@DSREF')) {
                    hasDsref = true;
                    break;
                }
            }
            
            if (hasDsref) {
                const fieldData = extractFieldData(lines, i);
                if (fieldData && fieldData.fieldName) {
                    results.push(fieldData);
                }
            }
        }
    }
    
    return results;
}

function extractFieldData(lines, fieldLineIndex) {
    const fieldData = {
        fieldName: '',
        classPath: [],
        dsref: { den: '', uid: '', cls: '' },
        aaa: { msg: [] },
        startLine: 0,
        endLine: 0,
        originalCode: ''
    };

    // === å‘ä¸Šæ‰¾ @DSREF / @AAA ===
    let currentLine = fieldLineIndex - 1;
    let dsrefLine = '';
    let aaaLines = [];
    let annotationStartLine = fieldLineIndex;

    while (currentLine >= 0 && currentLine >= fieldLineIndex - 20) {
        const line = lines[currentLine].trim();

        if (line.startsWith('@DSREF')) {
            dsrefLine = line;
            annotationStartLine = currentLine;
        } else if (line.startsWith('@AAA')) {
            let aaaStart = currentLine;
            let braceCount = 0;
            let aaaContent = '';

            for (let j = currentLine; j <= fieldLineIndex; j++) {
                const aaaLine = lines[j];
                aaaContent += aaaLine + '\n';
                braceCount += (aaaLine.match(/{/g) || []).length;
                braceCount -= (aaaLine.match(/}/g) || []).length;

                if (braceCount === 0 && aaaLine.includes('}')) {
                    break;
                }
            }
            aaaLines.push(aaaContent);
            if (aaaStart < annotationStartLine) {
                annotationStartLine = aaaStart;
            }
        } else if (line === '' || line.startsWith('//')) {
            // ç©ºè¡Œæˆ–è¨»è§£,ç¹¼çºŒ
        } else if (!line.startsWith('@')) {
            break; // é‡åˆ°éè¨»è§£è¡Œå°±åœ
        }

        currentLine--;
    }

    // è§£æ DSREF
    if (dsrefLine) {
        const denMatch = dsrefLine.match(/den\s*=\s*"([^"]*)"/);
        const uidMatch = dsrefLine.match(/uid\s*=\s*"([^"]*)"/);
        const clsMatch = dsrefLine.match(/cls\s*=\s*"([^"]*)"/);

        if (denMatch) fieldData.dsref.den = denMatch[1];
        if (uidMatch) fieldData.dsref.uid = uidMatch[1];
        if (clsMatch) fieldData.dsref.cls = clsMatch[1];
    }

    // è§£æ AAA
    if (aaaLines.length > 0) {
        const aaaText = aaaLines.join('');
        const msgPattern = /name=([^,]*),car=([^,]*),boro=([^,]*),chn=([^"]*)/g;
        let match;

        while ((match = msgPattern.exec(aaaText)) !== null) {
            fieldData.aaa.msg.push({
                name: match[1].trim(),
                car: match[2].trim(),
                boro: match[3].trim(),
                chn: match[4].trim()
            });
        }
    }

    // è§£ææ¬„ä½åç¨±
    const fieldLine = lines[fieldLineIndex];
    const fieldNameMatch = fieldLine.match(/(?:public|private|protected|)\s*\w+\s+(\w+)\s*[;=]/);
    if (fieldNameMatch) {
        fieldData.fieldName = fieldNameMatch[1];
    }

    // å‘ä¸Šæœå°‹é¡åˆ¥éšå±¤ (æœ€å¤š5å±¤)
    const classStack = [];
    let braceLevel = 0;

    for (let i = annotationStartLine; i >= 0 && classStack.length < 5; i--) {
        const line = lines[i];

        braceLevel += (line.match(/{/g) || []).length;
        braceLevel -= (line.match(/}/g) || []).length;

        const classMatch = line.match(/\b(?:static\s+)?class\s+(\w+)/);
        if (classMatch && braceLevel >= 1) {
            classStack.unshift(classMatch[1]);
        }
    }

    fieldData.classPath = classStack;
    fieldData.startLine = annotationStartLine;
    fieldData.endLine = fieldLineIndex;
    fieldData.originalCode = lines.slice(annotationStartLine, fieldLineIndex + 1).join('\n');

    return fieldData;
}

function batchProcessFields(fields, index, successCount, failedCount) {
    if (index >= fields.length) {
        // å®Œæˆ
        const percent = 100;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        
        updateProgress(fields.length, fields.length, successCount, failedCount, 'âœ… æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ!');
        document.getElementById('processingField').textContent = 'å·²å®Œæˆ';
        
        addProgressDetail(`\n========== åŒ¯å…¥å®Œæˆ ==========`, 'processing');
        addProgressDetail(`ç¸½è¨ˆ: ${fields.length} å€‹æ¬„ä½`, 'processing');
        addProgressDetail(`æˆåŠŸ: ${successCount} å€‹`, 'success');
        addProgressDetail(`å¤±æ•—: ${failedCount} å€‹`, failedCount > 0 ? 'error' : 'processing');
        
        let msg = `æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ!<br>`;
        msg += `ç¸½æ¬„ä½æ•¸: ${fields.length}<br>`;
        msg += `âœ… æˆåŠŸ: ${successCount}<br>`;
        msg += `âŒ å¤±æ•—: ${failedCount}`;
        
        showAlert(msg, failedCount > 0 ? 'warning' : 'success');
        return;
    }
    
    const field = fields[index];
    const currentField = field.fieldName || `æ¬„ä½ #${index + 1}`;
    const classPathStr = field.classPath && field.classPath.length > 0 
        ? ' [' + field.classPath.join('.') + ']' 
        : '';
    
    // æ›´æ–°é€²åº¦
    const percent = Math.round(((index + 1) / fields.length) * 100);
    updateProgress(index + 1, fields.length, successCount, failedCount, 
                   `è™•ç†ä¸­ (${index + 1}/${fields.length}): ${currentField}`);
    document.getElementById('processingField').textContent = currentField;
    
    addProgressDetail(`[${index + 1}/${fields.length}] è™•ç†: ${currentField}${classPathStr}`, 'processing');
    
    // æº–å‚™è³‡æ–™
    const saveData = {
        fileName: document.getElementById('fileName').textContent || 'MyMapping.java',
        syncToDb: true,
        fieldData: field
    };
    
    // ç™¼é€è«‹æ±‚
    fetch('/mig/updateFieldEnhanced', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saveData)
    })
    .then(r => r.json())
    .then(res => {
        if (res.success && res.dbSynced) {
            // æˆåŠŸ
            addProgressDetail(`  âœ“ æˆåŠŸ: ${currentField}`, 'success');
            
            // å»¶é²è™•ç†ä¸‹ä¸€å€‹ (é¿å…éå¿«,è®“ä½¿ç”¨è€…çœ‹åˆ°é€²åº¦)
            setTimeout(() => {
                batchProcessFields(fields, index + 1, successCount + 1, failedCount);
            }, 100);
        } else {
            // å¤±æ•—
            const errorMsg = res.message || res.dbSyncError || 'æœªçŸ¥éŒ¯èª¤';
            addProgressDetail(`  âœ— å¤±æ•—: ${currentField} - ${errorMsg}`, 'error');
            
            setTimeout(() => {
                batchProcessFields(fields, index + 1, successCount, failedCount + 1);
            }, 100);
        }
    })
    .catch(err => {
        // éŒ¯èª¤
        addProgressDetail(`  âœ— éŒ¯èª¤: ${currentField} - ${err.message}`, 'error');
        
        setTimeout(() => {
            batchProcessFields(fields, index + 1, successCount, failedCount + 1);
        }, 100);
    });
}

function updateProgress(current, total, success, failed, message) {
    const percent = total > 0 ? Math.round((current / total) * 100) : 0;
    
    // æ›´æ–°é€²åº¦æ¢
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
    
    // æ ¹æ“šé€²åº¦æ”¹è®Šé¡è‰²
    if (percent === 100) {
        progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    } else {
        progressBar.style.background = 'linear-gradient(90deg, #2196f3, #64b5f6)';
    }
    
    // æ›´æ–°æ–‡å­—
    document.getElementById('progressText').textContent = message;
    document.getElementById('progressPercent').textContent = `${current} / ${total}`;
    
    // æ›´æ–°çµ±è¨ˆ
    document.getElementById('totalCount').textContent = total;
    document.getElementById('successCount').textContent = success;
    document.getElementById('failedCount').textContent = failed;
}

function addProgressDetail(message, type) {
    const details = document.getElementById('progressDetails');
    const div = document.createElement('div');
    div.className = type === 'success' ? 'success-item' : 
                    type === 'error' ? 'error-item' : 'processing-item';
    
    // ç²å–ç•¶å‰æ™‚é–“
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    
    div.textContent = `[${timeStr}] ${message}`;
    details.appendChild(div);
    
    // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
    details.scrollTop = details.scrollHeight;
}

function displaySearchResults(results) {
    const resultsList = document.getElementById('searchResultsList');
    const resultCount = document.getElementById('resultCount');
    
    resultsList.innerHTML = '';
    resultCount.textContent = results.length;
    
    results.forEach((result, index) => {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.onclick = () => selectResult(index);
        
        const classPathStr = result.classPath && result.classPath.length > 0 
            ? result.classPath.join(' â†’ ') 
            : '(æ ¹å±¤ç´š)';
        
        // é¡¯ç¤ºè³‡æ–™åº«æ“´å……è³‡è¨Š
        let dbInfo = '';
        if (result.dbEnrichment) {
            const db = result.dbEnrichment;
            if (db.xmlTagName || db.objectClass || db.classHierarchy) {
                dbInfo = `<div class="db-enrichment">
                    <strong>è³‡æ–™åº«è³‡è¨Š:</strong> 
                    ${db.xmlTagName ? `XML Tag: ${db.xmlTagName}` : ''}
                    ${db.objectClass ? ` | Object Class: ${db.objectClass}` : ''}
                    ${db.classHierarchy && db.classHierarchy.length > 0 ? 
                        ` | é¡åˆ¥æ•¸: ${db.classHierarchy.length}` : ''}
                </div>`;
            }
        }
        
        item.innerHTML = `
            <div class="result-item-header">
                <div class="result-item-title">
                    ${result.fieldName}
                    <span class="badge badge-count">#${index + 1}</span>
                    ${result.dbEnrichment ? '<span class="badge badge-success">å·²æ“´å……</span>' : ''}
                </div>
            </div>
            <div class="result-item-path">
                é¡åˆ¥è·¯å¾‘: ${classPathStr}
            </div>
            <div class="result-item-code">${escapeHtml(result.originalCode)}</div>
            ${dbInfo}
        `;
        
        resultsList.appendChild(item);
    });
    
    document.getElementById('searchResultsSection').style.display = 'block';
}

function selectResult(index) {
    selectedResultIndex = index;
    currentFieldData = JSON.parse(JSON.stringify(allSearchResults[index]));
    
    document.querySelectorAll('.result-item').forEach((item, i) => {
        if (i === index) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    
    displayFieldData();
    
    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
}

function displayFieldData() {
    if (!currentFieldData) return;

    document.getElementById('resultSection').style.display = 'block';

    const classPathStr = currentFieldData.classPath && currentFieldData.classPath.length > 0 
        ? currentFieldData.classPath.join(' â†’ ') 
        : '(æ ¹å±¤ç´š)';
    document.getElementById('classPath').textContent = `é¡åˆ¥è·¯å¾‘: ${classPathStr}`;

    displayOriginalCode();
    
    // é¡¯ç¤ºè³‡æ–™åº«æ“´å……è³‡è¨Š
    if (currentFieldData.dbEnrichment) {
        displayDbEnrichment(currentFieldData.dbEnrichment);
    } else {
        document.getElementById('dbEnrichmentPanel').style.display = 'none';
    }

    document.getElementById('edit_fieldName').value = currentFieldData.fieldName || '';

    for (let i = 1; i <= 5; i++) {
        const classInput = document.getElementById(`edit_class${i}`);
        if (classInput) {
            classInput.value = (currentFieldData.classPath && currentFieldData.classPath[i - 1]) || '';
        }
    }

    document.getElementById('edit_dsref_den').value = currentFieldData.dsref?.den || '';
    document.getElementById('edit_dsref_uid').value = currentFieldData.dsref?.uid || '';
    document.getElementById('edit_dsref_cls').value = currentFieldData.dsref?.cls || '';

    rebuildMsgRows();

    document.getElementById('previewSection').style.display = 'none';
}

function displayDbEnrichment(dbEnrichment) {
    const panel = document.getElementById('dbEnrichmentPanel');
    const content = document.getElementById('dbEnrichmentContent');
    
    let html = '';
    
    // TWDENS è³‡è¨Š
    if (dbEnrichment.xmlTagName || dbEnrichment.objectClass) {
        html += `<div class="db-info-item"><strong>TWDENS:</strong></div>`;
        if (dbEnrichment.xmlTagName) {
            html += `<div class="db-info-item">&nbsp;&nbsp;XML Tag Name: ${dbEnrichment.xmlTagName}</div>`;
        }
        if (dbEnrichment.objectClass) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Object Class: ${dbEnrichment.objectClass}</div>`;
        }
        if (dbEnrichment.propertyTerm) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Property Term: ${dbEnrichment.propertyTerm}</div>`;
        }
    }
    
    // TWCLS é¡åˆ¥éšå±¤
    if (dbEnrichment.classHierarchy && dbEnrichment.classHierarchy.length > 0) {
        html += `<div class="db-info-item" style="margin-top:10px;"><strong>TWCLS é¡åˆ¥éšå±¤ (${dbEnrichment.classHierarchy.length}):</strong></div>`;
        dbEnrichment.classHierarchy.forEach((cls, idx) => {
            html += `<div class="db-info-item">&nbsp;&nbsp;${idx + 1}. ${cls.className || cls.objectClass}`;
            if (cls.chName) html += ` (${cls.chName})`;
            html += `</div>`;
        });
    }
    
    // TWIDS è³‡è¨Š
    if (dbEnrichment.twidEnName || dbEnrichment.twidEnDef) {
        html += `<div class="db-info-item" style="margin-top:10px;"><strong>TWIDS:</strong></div>`;
        if (dbEnrichment.twidEnName) {
            html += `<div class="db-info-item">&nbsp;&nbsp;EN Name: ${dbEnrichment.twidEnName}</div>`;
        }
        if (dbEnrichment.twidEnDef) {
            html += `<div class="db-info-item">&nbsp;&nbsp;EN Def: ${dbEnrichment.twidEnDef}</div>`;
        }
    }
    
    // TWDS è³‡è¨Š
    if (dbEnrichment.chNameDef || dbEnrichment.enName) {
        html += `<div class="db-info-item" style="margin-top:10px;"><strong>TWDS:</strong></div>`;
        if (dbEnrichment.enName) {
            html += `<div class="db-info-item">&nbsp;&nbsp;EN Name: ${dbEnrichment.enName}</div>`;
        }
        if (dbEnrichment.format) {
            html += `<div class="db-info-item">&nbsp;&nbsp;Format: ${dbEnrichment.format}</div>`;
        }
    }
    
    if (html) {
        content.innerHTML = html;
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

function rebuildMsgRows() {
    const tbody = document.getElementById('fieldTableBody');
    
    const existingMsgRows = tbody.querySelectorAll('.msg-row');
    existingMsgRows.forEach(row => row.remove());

    msgCounter = 0;

    if (!currentFieldData.aaa || !currentFieldData.aaa.msg || currentFieldData.aaa.msg.length === 0) {
        if (!currentFieldData.aaa) currentFieldData.aaa = { msg: [] };
        currentFieldData.aaa.msg.push({ name: '', car: '', boro: '', chn: '' });
    }
    
    currentFieldData.aaa.msg.forEach((msg, index) => {
        addMsgRowWithData(msg, index);
    });
}

function addMsgRowWithData(msgData, index) {
    const tbody = document.getElementById('fieldTableBody');
    const id = msgCounter++;

    const rows = [
        createMsgRow('AAA msg', 'name', id, msgData.name, index === 0),
        createMsgRow('AAA msg', 'car', id, msgData.car, false),
        createMsgRow('AAA msg', 'boro', id, msgData.boro, false),
        createMsgRow('AAA msg', 'chn (TWDS.chName)', id, msgData.chn, false)
    ];

    rows.forEach(row => tbody.appendChild(row));
}

function addMsgRow() {
    const msgData = { name: '', car: '', boro: '', chn: '' };
    addMsgRowWithData(msgData, currentFieldData.aaa.msg.length);
    currentFieldData.aaa.msg.push(msgData);
}

function createMsgRow(type, field, id, value, showDelete) {
    const tr = document.createElement('tr');
    tr.className = 'field-row msg-row';
    tr.setAttribute('data-msg-id', id);
    tr.setAttribute('data-msg-field', field);

    tr.innerHTML = `
        <td>${type}</td>
        <td>${field}</td>
        <td><input type="text" value="${escapeHtml(value || '')}" data-msg-id="${id}" data-field="${field}" /></td>
        <td>${showDelete ? `<button class="btn btn-danger" onclick="deleteMsgRow(${id})">åˆªé™¤</button>` : ''}</td>
    `;

    return tr;
}

function deleteMsgRow(msgId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ msg é …ç›®å—?')) return;

    const rows = document.querySelectorAll(`[data-msg-id="${msgId}"]`);
    rows.forEach(row => row.remove());

    collectFormData();
}

function displayOriginalCode() {
    const code = generateCode(currentFieldData);
    document.getElementById('originalCode').textContent = code;
}

function generateCode(data) {
    const msgLines = data.aaa && data.aaa.msg ? data.aaa.msg.map(msg => 
        `    "name=${msg.name || ''},car=${msg.car || ''},boro=${msg.boro || ''},chn=${msg.chn || ''}",//`
    ).join('\n') : '';

    return `@DSREF(den = "${data.dsref?.den || ''}", uid = "${data.dsref?.uid || ''}", cls = "${data.dsref?.cls || ''}")
@AAA(msg = {
//
${msgLines}
})
public String ${data.fieldName || ''};`;
}

function previewCode() {
    collectFormData();
    const code = generateCode(currentFieldData);
    document.getElementById('previewCode').textContent = code;
    document.getElementById('previewSection').style.display = 'block';
}

function collectFormData() {
    currentFieldData.fieldName = document.getElementById('edit_fieldName').value;
    
    // æ”¶é›†é¡åˆ¥è·¯å¾‘
    currentFieldData.classPath = [];
    for (let i = 1; i <= 5; i++) {
        const classValue = document.getElementById(`edit_class${i}`).value.trim();
        if (classValue) {
            currentFieldData.classPath.push(classValue);
        }
    }
    
    if (!currentFieldData.dsref) currentFieldData.dsref = {};
    currentFieldData.dsref.den = document.getElementById('edit_dsref_den').value;
    currentFieldData.dsref.uid = document.getElementById('edit_dsref_uid').value;
    currentFieldData.dsref.cls = document.getElementById('edit_dsref_cls').value;

    // æ”¶é›† msg è³‡æ–™
    const msgMap = new Map();
    const inputs = document.querySelectorAll('.msg-row input');
    
    inputs.forEach(input => {
        const msgId = input.getAttribute('data-msg-id');
        const field = input.getAttribute('data-field');
        
        if (!msgMap.has(msgId)) {
            msgMap.set(msgId, {});
        }
        
        msgMap.get(msgId)[field] = input.value;
    });

    if (!currentFieldData.aaa) currentFieldData.aaa = {};
    currentFieldData.aaa.msg = Array.from(msgMap.values());
}

function saveChanges() {
    if (!confirm('ç¢ºå®šè¦å„²å­˜è®Šæ›´å—?')) return;

    collectFormData();

    const syncToDb = document.getElementById('syncToDb').checked;

    // æº–å‚™é€åˆ°å¾Œç«¯çš„è³‡æ–™
    const saveData = {
        fileName: document.getElementById('fileName').textContent || 'MyMapping.java',
        syncToDb: syncToDb,
        fieldData: currentFieldData
    };

    showAlert('å„²å­˜ä¸­... <span class="loading"></span>', 'info');

    fetch('/mig/updateFieldEnhanced', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saveData)
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            let msg = 'è®Šæ›´å·²æˆåŠŸå„²å­˜!';
            if (res.backupPath) {
                msg += `<br>å‚™ä»½æª”æ¡ˆ: ${res.backupPath}`;
            }
            if (res.dbSynced) {
                msg += '<br>âœ… è³‡æ–™å·²åŒæ­¥è‡³è³‡æ–™åº«';
            } else if (syncToDb && res.dbSyncError) {
                msg += `<br>âš ï¸ è³‡æ–™åº«åŒæ­¥è­¦å‘Š: ${res.dbSyncError}`;
            }
            
            showAlert(msg, 'success');
            displayOriginalCode();
            
            if (selectedResultIndex >= 0) {
                allSearchResults[selectedResultIndex] = JSON.parse(JSON.stringify(currentFieldData));
                displaySearchResults(allSearchResults);
            }
        } else {
            showAlert('å„²å­˜å¤±æ•—: ' + res.message, 'error');
        }
    })
    .catch(err => {
        showAlert('å„²å­˜å¤±æ•—: ' + err.message, 'error');
        console.error(err);
    });
}

function showAlert(message, type) {
    const alertBox = document.getElementById('alertBox');
    const className = type === 'success' ? 'alert-success' : 
                     type === 'error' ? 'alert-error' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    alertBox.innerHTML = `<div class="alert ${className}">${message}</div>`;
    
    // info é¡å‹ä¸è‡ªå‹•æ¶ˆå¤± (å› ç‚ºå¯èƒ½åŒ…å« loading)
    if (type !== 'info') {
        setTimeout(() => {
            alertBox.innerHTML = '';
        }, 5000);
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

// æš´éœ²åˆ°å…¨åŸŸ
window.handleFileUpload = handleFileUpload;
window.uploadFile = uploadFile;
window.searchField = searchField;
window.suggestFromDb = suggestFromDb;
window.batchImportToDb = batchImportToDb;
window.selectResult = selectResult;
window.addMsgRow = addMsgRow;
window.deleteMsgRow = deleteMsgRow;
window.previewCode = previewCode;
window.saveChanges = saveChanges;

</script>
</div>
</body>
</html>